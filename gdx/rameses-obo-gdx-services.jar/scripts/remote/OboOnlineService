import com.rameses.annotations.*
import com.rameses.util.*
import com.rameses.common.*
import com.rameses.services.extended.*

class OboOnlineService  {

    @Service(value="TDOnlineService", connection="local-etracs-server")
    def svc;

    @Service(value="EntityService", connection="local-entity-server")
    def entitySvc;

    @Service(value="BuildingPermitOnlineService", connection="local-obo-server")
    def localOboSvc;

    @Service(value="BuildingPermitService", connection="local-obo-server")
    def bldgPermitSvc;

    @Service(value="obo/OnlineBuildingPermitDownloadService", connection="cloud-server")
    def downloadSvc;

    @ProxyMethod
    public def findLocation( def params ) {
        def info = svc.verifyTaxDec(params);

        if(info.state != "CURRENT" ) {
            throw new Exception("The tax declaration must be in current state. Please verify with the assessors office");
        }    

        info.refid = info.objid;
        if(!info.taxpayer?.objid ) 
        	throw new Exception("Error in OboOnlineService. There is no taxpayer.objid returned in TDOnlineService");
        def txp = info.remove("taxpayer");   

        info.lotno = info.remove("cadastrallotno");
        
        def entity = entitySvc.open( [objid: txp.objid ] );
        info.owner.putAll( 
            [
                profileid: entity.objid,
                profileno: entity.entityno,
                birthdate: entity.birthdate,
                email: entity.email,
                mobileno: entity.mobileno,
                gender: entity.gender,
                name: entity.name,
                entitytype: entity.type,
                lastname: entity.lastname,
                firstname: entity.firstname,
                middlename: entity.middlename,
                tin: entity.tin,
                address: entity.address
            ]
        );
        info.owner.resident =  (entity.address.type == "nonlocal") ? 0 : 1;
        return info;
    }
    
    @ProxyMethod
    public def findProfessional( def o ) {
        println "finding professional via prc no. ->"+o;
        throw new Exception("Record not found");
    }

    @ProxyMethod
    public def submitOnlineApplication( def o ) {
        def app = downloadSvc.getInfo( [appid: o.appid ] );
        localOboSvc.upload( app );
        return [status: 'OK'];
    }

    @ProxyMethod
    public def findBldgPermitNo( def params ) {
        def res = bldgPermitSvc.findByPermitNo( [permitno: params.permitno ] );
        if(res==null)
            throw new Exception("Permit no " + params.permitno + " not found");
        res.each { k,v->
            println k+"="+v;
        }
        return res;
    }

}
