import com.rameses.annotations.*;
import com.rameses.util.*;
import java.rmi.server.*;
import obo.facts.*;
import java.text.*;

import javax.mail.*;
import javax.mail.internet.*;
import javax.activation.*;
import java.util.*;


public class OboEmailService  {

	@XConnection("smtp")
	def mailSvc;

	@ProxyMethod
	public def send( def params ) {
		def s = [to: params.to, subject:params.subject, message: params.msg ] ;
		s.attachments = [];
		s.attachments << '/apps/server/fileroot/reqchecklist.pdf';
		s.attachments << '/apps/server/fileroot/claimstub.pdf';		
		emailsend( s );
		return "message sent with attachment 2";
	}

	public def emailsend( o ) {
		if ( !o.to ) throw new Exception("to is required in SmtpService");
		if ( !o.subject ) throw new Exception("subject is required in SmtpService"); 
		if ( !o.message ) throw new Exception("message is required in SmtpService"); 
		  
		def conf = mailSvc.conf;
		String smtphost = conf.get("mail.smtp.host"); 
		if ( !smtphost ) throw new Exception("mail.smtp.host is required in smtp file"); 

		String from = conf.get("mail.from"); 
		String to = o.to;
		String subject = o.subject;
		String txtmsg = o.message;

		//Properties properties = System.getProperties();  
		Properties properties = new Properties();
		properties.setProperty("mail.smtp.host", smtphost);  
		Session session = Session.getDefaultInstance( properties );   

		try { 
		    MimeMessage message = new MimeMessage(session);  
		    message.setFrom(new InternetAddress(from));  
		    message.addRecipient(Message.RecipientType.TO, new InternetAddress(to)); 
		    if (subject) message.setSubject(subject); 

		    if ( o.attachments ) {
		     	BodyPart messageBodyPart = new MimeBodyPart();
		     	if ( txtmsg ) messageBodyPart.setText( txtmsg );

		     	Multipart multipart = new MimeMultipart();
		     	multipart.addBodyPart(messageBodyPart);

		     	o.attachments.each { filename->
		         	messageBodyPart = new MimeBodyPart();
		         	File f = new File(filename);
		         	DataSource source = new FileDataSource(filename);
			        messageBodyPart.setDataHandler(new DataHandler(source));
			        messageBodyPart.setFileName(filename);
			        multipart.addBodyPart(messageBodyPart);
		     	} 
		     	message.setContent(multipart); 
		    } 
		    
		    else if ( txtmsg ) { 
		    	message.setContent(txtmsg, "text/html");
		    }

		    Transport.send(message); 
		    return "OK";
		} 
		catch (RuntimeException re) { 
			throw re;  
		} 
		catch (Exception e) {  
			throw e; 
		}  
	}


}