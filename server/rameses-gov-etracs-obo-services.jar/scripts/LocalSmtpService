import com.rameses.annotations.*;
import com.rameses.util.*;
import java.util.*;
import javax.mail.*;
import javax.mail.internet.*;
import javax.activation.*;
import java.io.*;

public class LocalSmtpService  {

	@XConnection("local-smtp")
   	def mailSvc;

	@ProxyMethod
	public def send(def o) {
		if(!o.to) throw new Exception("to is required in LocalSmtpService");
		if(!o.subject) throw new Exception("subject is required in LocalSmtpService")
		if(!o.message) throw new Exception("message is required in LocalSmtpService")
          
        def conf = mailSvc.conf
        String from = conf.get("mail.from"); 
        String to = o.to;
        String subject = o.subject;
		String txtmsg = o.message;

        Properties properties = System.getProperties();  
        properties.setProperty("mail.smtp.host", conf.get("mail.smtp.host") );  
        Session session = Session.getDefaultInstance(properties);  
    
        try { 
            MimeMessage message = new MimeMessage(session);  
            message.setFrom(new InternetAddress(from));  
            message.addRecipient(Message.RecipientType.TO, new InternetAddress(to)); 
            if(subject) message.setSubject(subject); 

            if( !o.attachments ) {
            	if(txtmsg) message.setText(txtmsg);
            }
            else {
	         	BodyPart messageBodyPart = new MimeBodyPart();
	         	if(txtmsg) messageBodyPart.setText(txtmsg);
	         	Multipart multipart = new MimeMultipart();
	         	multipart.addBodyPart(messageBodyPart);

	         	o.attachments.each { filename->
		         	messageBodyPart = new MimeBodyPart();
		         	DataSource source = new FileDataSource(filename);
			        messageBodyPart.setDataHandler(new DataHandler(source));
			        messageBodyPart.setFileName(filename);
			        multipart.addBodyPart(messageBodyPart);
	         	}
	         	message.setContent(multipart);
            }
            Transport.send(message); 
            return "OK";
        } 
        catch (MessagingException mex) { 
        	throw mex;
        } 
	}

	@ProxyMethod
	public def testSend() {
		def m = [to: "elmonazareno@gmail.com"];
		m.subject = "Test Email";
		m.message = "Please see attachments";
		m.attachments = [];
		m.attachments << "/Users/elmonazareno/RAMESES/zzfiles/JV_POSTING.jpg";
		m.attachments << "/Users/elmonazareno/RAMESES/zzfiles/LGU-BFP-Integration.pdf";	
		return send(m);
	}

}