import com.rameses.annotations.*;
import java.rmi.server.*;

public class OboMenuNotificationService {
	
	@DataContext("vw_building_permit_section")
	def appTask;

	@DataContext("building_permit")
	def vwApp;

	@Service("WorkflowTaskListService")
	def taskSvc;

	def getTaskCount( def r ) {
		//use self so that it will fire the interceptors
    	def nodes = taskSvc.getNodeList( r );
    	def d = nodes.findAll{it.name!='mytask'}.findAll{it.count!=null}.sum{ it.count };
    	return d;
	}

	def building_permit = { o->
		def r = [processname: 'building_permit'];
		r._schemaname = "vw_building_permit";
		r.domain = o.domain;
		return getTaskCount(r);		
	}
	
	def building_permit_section = { o->
		def r = [processname: 'building_permit_section'];
		r._schemaname = "vw_building_permit_section";
		r.domain = o.domain;
		r.where = [ " typeid = :typeid", [typeid: o.typeid.toUpperCase() ] ];
		return getTaskCount(r);		
	}

	def occupancy_permit = { o->
		def r = [processname: 'occupancy_permit'];
		r._schemaname = "vw_occupancy_permit";
		r.domain = o.domain;
		return getTaskCount(r);		
	}
	
	def occupancy_permit_section = { o->
		def r = [processname: 'occupancy_permit_section'];
		r._schemaname = "vw_occupancy_permit_section";
		r.domain = o.domain;
		r.where = [ " typeid = :typeid", [typeid: o.typeid.toUpperCase() ] ];
		return getTaskCount(r);		
	}

	@ProxyMethod
	public def fetchNotifications( def p ) {
		def result = p.items;
		p.domain = "OBO";
		result.each { 
			if( it.id == 'building_permit' ) {
				it.count = building_permit( p );
			}
			else if( it.id == 'occupancy_permit') {
				it.count = occupancy_permit( p );
			}			
			else if( p.event == 'building_permit_section') {
				p.typeid = it.id?.split(":")[1];
				it.count = building_permit_section( p );
			}
			else if( p.event == 'occupancy_permit_section') {
				p.typeid = it.id?.split(":")[1];
				it.count = occupancy_permit_section( p );
			}			
		}	
		return result;
	}

}