import com.rameses.annotations.*;

public class OboMenuNotificationService {
	
	@DataContext("vw_building_permit_evaluation")
	def appTask;

	@DataContext("building_permit")
	def vwApp;

	@ProxyMethod
	public def fetchNotifications( def p ) {
		p.items.each {
			def id = it.id;
			if(id.startsWith("building_permit_evaluation")) {
				def c = id.split(":")[1];
				it.count = appTask.select("c:{COUNT(*)}").where("typeid = :typ AND task.state NOT IN('revision', 'end')", [typ:c] ).val();
			}
			else if(id == "building_permit_online"){
				it.count = vwApp.select("c:{COUNT(*)}").where( "taskid IS NULL ").val();
			}
		}
		return p;
	}

}