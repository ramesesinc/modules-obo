import com.rameses.annotations.*;
import com.rameses.util.*;
import java.rmi.server.*;
import obo.facts.*;
import java.text.*;
import treasury.utils.*;
import treasury.facts.*;
import enterprise.utils.*;

public class OboAssessmentService  {

	@Service("BillingRuleService")
	def billingRuleSvc;

	@Service("DateService")
	def dateSvc;

	@DataContext("obo_itemaccount")
	def itemAccountEm;

	@DataContext("building_permit_ancillary")
	def ancillaryEm;

	@Service("BuildingPermitInfoService")
	def infoSvc;

	@ProxyMethod
	public def assess(o) {
		def appid = o.app.remove("appid");
		//load the related infos. find the related ancillary permit to get the info parentid
		if(o.sectionid) {
			def anc = ancillaryEm.find( [appid: appid, permittypeid: o.sectionid ] ).first();
			if( anc ) {
				def zinfos = infoSvc.getInfos( [parentid: anc.objid ]);
				o.infos = zinfos;
			}
		}
		def res = billingRuleSvc.execute( [rulename:'oboassessment', params: o, include_items: false ] );
		def bitems = [];
		res.billitems.each {
			def p = itemAccountEm.find( [objid: it.billcode ] ).first();
			it.item = p;
			if( p?.type?.objid?.equalsIgnoreCase(o.sectionid) ) {
				it.sortorder = (p.sortorder == null ? 100 : p.sortorder);
				bitems << it;
			}
		}
		return bitems;
		//return  bitems.findAll{ it.amount > 0 }.sort{ it.sortorder };	

		/*
		res.billitems.findAll{ it.billcode && it.item == null }.each {
			def p = itemAccountEm.find( [objid: it.billcode ] ).first()
			if( o.sectionid ) {
				if(p.type.objid?.equalsIgnoreCase(o.sectionid) ) {
					it.item = p;
					it.sortorder = (p.sortorder == null ? 100 : p.sortorder);
					bitems << it;				
				}
			}
			else {
				it.item = p;
				it.sortorder = (p.sortorder == null ? 100 : p.sortorder);
				bitems << it;				
			}
		}
		def billitems = bitems.findAll{ it.amount > 0 }.sort{ it.sortorder };
		return billitems;
		*/
	}

}