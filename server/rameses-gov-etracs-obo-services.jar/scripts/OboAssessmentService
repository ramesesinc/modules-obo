import com.rameses.annotations.*;
import com.rameses.util.*;
import java.rmi.server.*;
import obo.facts.*;
import java.text.*;
import treasury.utils.*;
import treasury.facts.*;
import enterprise.utils.*;

public class OboAssessmentService  {

	@Service("BillingRuleService")
	def billingRuleSvc;

	@Service("DateService")
	def dateSvc;

	@DataContext("obo_billitemtype")
	def billItemTypeEm;

	@ProxyMethod
	public def assess(o) {
		def res = billingRuleSvc.execute( [rulename:'oboassessment', params: o, include_items: false ] );
		res.billitems.findAll{ it.billcode && it.item == null }.each {
			def p = billItemTypeEm.find( [objid: it.billcode ] ).first()
			it.item = p.item;
			it.sortorder = (p.sortorder == null ? 100 : p.sortorder);
		}
		return res.billitems.findAll{ it.amount > 0 }.sort{ it.sortorder };
	}

}