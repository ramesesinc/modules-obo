import com.rameses.annotations.*; 

class BuildingPermitFormReportInterceptor {
	
	@DataContext("vw_building_application")
	def vwApp;

	@DataContext("building_application_payment")
	def pmtEm;

	@DataContext("building_permit")
	def permitEm;

	@DataContext("obo_doctype")
	def doctypeEm;

	@After(pattern="FormReportService.getData", eval="#{ args[0].reportid == 'building_permit' }")
	public void getBuildingPermitReport( def evt ) {
		def p = evt.args[0];

		def result = evt.result;
		def id = p.parameters.objid;

		def app = vwApp.find( [objid: id ] ).first();
		if( !app.issuanceid )
			throw new Exception("Building permit not yet issued");

		def doctype = doctypeEm.find( [objid: 'BUILDING_PERMIT'] ).first();
		app.template = doctype.template;

		def pmt = pmtEm.find( [appid: app.objid ]).where("voided = 0").first();
		app.receiptno = pmt.refno;
		app.receiptdate = pmt.refdate;
		app.amount = pmt.amount;
		
		app.worktypes = app.worktypes?.join(", ");
		result.data = app;
	}	


}