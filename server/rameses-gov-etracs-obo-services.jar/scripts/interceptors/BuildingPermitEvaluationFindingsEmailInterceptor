import com.rameses.annotations.*; 

class BuildingPermitEvaluationFindingsEmailInterceptor {
	
	@Service("TemplateService")
	def templateService;

	@Service(value="SmtpService", connection="email-sms-server")
	def smtpSvc;

	@DataContext("building_permit_finding")
	def findingEm;

	@After(pattern="WorkflowTaskService.signal", eval="#{args[0].processname == 'building_permit' && args[0].action == 'for-revision' }")public void sendEmailAfterRevision( def evt ) {
		def p = evt.args[0];
		def appid = p.refid;
		def data = [:];
		data.name = "Nazareno, Elmo";
		data.findings = findingEm.find([appid: appid]).where("status = 'FOR-REVISION'").list();

		def msg = templateService.get( "building_permit_evaluation_findings", [data:data] ).toString();

		smtpSvc.send( [to: "elmonazareno@gmail.com", subject:"findings", message: msg] );
	}
}