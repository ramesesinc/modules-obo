
<script type="text/javascript">
\$put("professional", new function() {
	var self = this;
	this.mode;
	this.idno;
	this.prof = {};
  this.selectedItem;
  this.barangayList;

  var app = \$get("app").code;

	this.professions = ["ARCHITECT", "CIVIL ENGINEER","GEODETIC ENGINEER", "PROFESSIONAL ELECTRICAL ENGINEER", "REGISTERED ELECTRICAL ENGINEER", "MECHANICAL ENGINEER"];
  this.professionalList;

  var loadList = function() {
    self.professionalList = app.service.getProfessionalList( {appid: app.appid } ); 
  }

  this.findRefno = function() {
    var svc = Service.lookup( app.orgcode + ":OboOnlineService" );
    svc.findProfessional( {refno: self.idno }, function(o,s) {
      if( s == "error" ) {
        self.mode = "entry-not-found";
      }
      else {
        self.prof = o.result;
        self.mode = "view-entry";
      }
      self._controller.refresh();
    });
  }

  var initEdit = function() {
    if( !self.barangayList ) {
      var bsvc = Service.lookup("CloudPartnerService", "partner");
      self.barangayList = bsvc.getBarangayList( {orgcode: app.orgcode} );
    }
    self.mode = "edit-entry";
  }

  this.addNew = function() {
    self.prof = { address: {barangay:{}}, resident: 1 };
    initEdit();
  }

  this.editItem = function() {
    if(!this.selectedItem) throw new Exception("Please select an item");
    self.prof = app.service.getProfessional( {objid: this.selectedItem.objid } );
    initEdit();
  }

  this.removeItem = function() {
    if(!this.selectedItem) throw new Exception("Please select an item");
    var b = confirm("You are about to remove this entry. Proceed?");
    if( b ) {
      app.service.removeProfessional( {objid: this.selectedItem.objid } );
      loadList();
      self._controller.refresh();
    }
  }

  this.viewInitial = function() {
    self.mode = "initial";
  }

  this.save = function() {
    self.prof.appid = app.appid;
    app.service.saveProfessional( self.prof );
    loadList();
    self.mode = "view-list";
  }

  this.finish = function() {
    app.moveNextStep();
  }

  this.cancelEdit = function() {
    if( !confirm('This will discard all data edited. Proceed ')) return;
    self.mode = "view-list";
  }

  this.onload = function() {
    loadList();
    self.mode = "view-list";
    app.updateStepNavbar();
  }

  this.attachId = function() {
    var h = function(v) {
      self.prof.id = v;
      self._controller.refresh();
    }
    return new PopupOpener( "id_entry", { onselect: h, entry: self.prof.id},  {width:'500', title:'Select Proof of Identity'} );
  }

  this.attachPRC = function() {
    var h = function(v) {
      self.prof.prc = v;
      self._controller.refresh();
    }
    var p = { onselect:h, idtype:'prc', idtitle:'Professional Regulation Commission', idcaption:'PRC No', show_validitydate: 'true' }
    var pop = new PopupOpener( "id_entry", p , {width:'500', title:'Professional Regulation Commission'} ); 
    return pop;
  }

  this.attachPTR = function() {
    var h = function(v) {
      self.prof.ptr = v;
      self._controller.refresh();
    }
    var p = { onselect: h, idtype:'ptr', idtitle:'Professional Tax Receipt', idcaption:'PTR No'}    
    return new PopupOpener( "id_entry", p,  {width:'500', title:'Professional Tax Receipt'} );
  }


});

\$register( {id:'id_entry',  page:"${PAGE.parentPath}/id_entry", context: 'id_entry' } );
</script>

<style>
  .caption-class { width: 200px;}
  .subcaption-class { width : 100px; }
</style>


<legend>List of Licensed Professionals</legend>

<div r:context="professional" r:visibleWhen="#{mode=='initial'}">
	<p style="padding-bottom:10px">Specify technical persons involved who will require signature on the project (e.g. architect, civil engineer, etc):</p> 
  <div class="form">
    @wx:text(caption:'Search PRC No', context:'professional', name:'idno', required: true, captionClass: '+w150')
  </div>
  @wx:button( caption:'Next', context:'professional', name:'findRefno')
</div>

<div r:context="professional" r:visibleWhen="#{mode=='entry-not-found'}">
  <div  style="padding-bottom:10px">
    <label r:context="professional"> 
      <p>Name with PRC No <b>#{idno}</b> not found. Add New Entry?</p> 
    </label>
  </div>
  @wx:button( caption:'Cancel', context:'professional', name:'viewInitial')
  @wx:button( caption:'Add New', context:'professional', name:'addNew')
</div>

<div  r:context="professional" r:visibleWhen="#{mode == 'view-list'}">
  <label class="control-label">List of Professionals</label>
  <table r:context="professional" r:items="professionalList" r:varName="item" r:name="selectedItem" border="1px" style="width:100%">
    <thead>
      <tr>
        <td>PRC No</td>
        <td>Profession</td>        
        <td>Name</td>
        <td>Address</td>
        <td>&nbsp;</td>        
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>#{item.prc.idno}</td>
        <td>#{item.profession}</td>        
        <td>#{item.name}</td>
        <td>#{item.address.text}</td>
        <td>
          <a href="#" r:context="professional" r:name="editItem">Edit</a> 
          &nbsp;&nbsp;
          <a href="#" r:context="professional" r:name="removeItem">Remove</a> 
        </td>
      </tr>
    </tbody>
  </table>
  <br>
  @wx:button( caption:'Add New Entry', context:'professional', name:'addNew')
  @wx:button( caption:'Next', context:'professional', name:'finish')
</div>


<div r:context="professional" r:visibleWhen="#{mode=='edit-entry'}" style="display:none">
  <p>Please fill in the necessary data below. Text marked with * are required fields. </p>
  <div class="form">
    @wx:combo(caption:'Primary Profession', context:'professional', name:'prof.profession', required: true, inputClass:'+w250', 
      attrs:[items:'professions', emptyText:'-', allowNull: true ])
    @wx:text(caption:'Last Name', context:'professional', name:'prof.lastname', required: true, hint:'Last Name')
    @wx:text(caption:'First Name', context:'professional', name:'prof.firstname', required: true, hint:'First Name' )
    @wx:text(caption:'Middle Name', context:'professional', name:'prof.middlename', required: true, hint:'Middle Name')
    @wx:date(caption:'Birthdate', context:'professional', name:'prof.birthdate', required: true, hint:'Birth date in YYYY-MM-DD')
    @wx:gender(context:'professional', name:'prof.gender', required:true )

    @wx:radiolist( caption:'Resident', context:'professional', name:'prof.resident', required:true, items: [ [key:'1', value:'Resident'], [key:'0', value:'Non-resident' ] ] )
    @wx:address_local( caption: 'Address', context:'professional', name:'prof.address', depends: 'prof.resident', visibleWhen: '#{ prof.resident == \'1\' }', required:true )
    @wx:address_nonlocal( caption: 'Address', context:'professional', name:'prof.address', depends: 'prof.resident', visibleWhen: '#{ prof.resident == \'0\' }', required:true )

    @wx:email(context:'professional', name:'prof.email', required:true)
    @wx:mobile(context:'professional', name:'prof.mobileno' )

    <br>
    @wx:idproof( context:'professional', name:'prof.id', action:'attachId' )
    <br>
    @wx:idproof( context:'professional', name:'prof.prc', action:'attachPRC', caption:'Professional Regulation Commission [PRC]' )
    <br>
    @wx:idproof( context:'professional', name:'prof.ptr', action:'attachPTR', caption: 'Professional Tax Receipt [PRC]' )

  </div>  
  @wx:button( caption:'Cancel', context:'professional', name:'cancelEdit', attrs:[immediate:true])
  @wx:button( caption:'Save and Add To List', context:'professional', name:'save')
</div>
