<%
	def oboSvc = SERVICE.lookup("OnlineBuildingPermitService", "obo");
	def accessoryList = oboSvc.getAccessories( [appid: PARAMS.appid ] );

	def svc = SERVICE.lookup("OboMiscListService", "obo");	
	def occupancyTypes = svc.getAccessoryOccupancyTypes();	

	def infoList;
	boolean hasItems;	
	if( accessoryList ) {
		infoList = [];
		accessoryList.each { ac ->
			occupancyTypes.find{ vv -> vv.objid == ac.type.objid }?.checked = 1;
			infoList.addAll( ac.infos );
		}
		hasItems = true;
	}	
	else {
		hasItems = false;
	}
%>

<!-- comment script here -->
<script>
\$put("accessories", new function() {
	var self = this;
	//load accessories
	var app = \$get("app").code;	
	this.mode;
	this.infoMap = {};

	this.accessoryTypes = {};
	<%occupancyTypes.each { ot ->%>
	this.accessoryTypes.${ot.objid.toLowerCase()} = ${ ot.checked == 1 ? 1: 0 };	
	<%}%>

	<%if( hasItems ) { infoList.each { o-> %>
	this.infoMap.${o.name.toLowerCase()} = ${o.value == null ? null : o.value}; 
	<%}}%>

	this.onload = function() {
		this.mode = "${ hasItems == false ? 'select-accessory' : 'view-list' }";
		app.updateStepNavbar();	
	}

	

	this.saveAndContinue = function() {
		var items = [];
		var deleted = [];
		for( var prop in self.accessoryTypes ) {
			if( self.accessoryTypes[prop] == 1 ) {
				items.push( prop );
			}
			else {
				deleted.push(prop);
			}
		}
		if( items.length > 0 ) {
			var p = {};
			p.appid = app.appid;
			p.items = items;
			p.deleted = deleted;
			app.service.saveAccessories( p );
			window.location.reload();
		}
		else {
			if( deleted.length > 0 ) {
				var p = {};
				p.appid = app.appid;
				p.items = [];
				p.deleted = deleted;
				app.service.saveAccessories( p );
			}
			app.moveNextStep();
		}
	}

	this.saveAccesoryInfos = function() {
		var p = {appid: app.appid };
		p.infos = [];
		for( var prop in self.infoMap ) {
			p.infos.push( {name: prop, value: self.infoMap[prop ] } );	
		}
		app.service.saveAccessoryInfos( p );
	}

	this.redoSelection = function() {
		var b = confirm("Unchecking will remove the accessory information already encoded. Continue anyway?");
		if(!b) return;
		self.mode = "select-accessory";
	}

});	
</script>

<legend>Accessories</legend>
<div r:context="accessories" r:visibleWhen="#{ mode == 'select-accessory' }" style="display:none;">
	<div style="padding-bottom:10px;">Select accessory to add</div>
	<%occupancyTypes.each { o-> %>
		<div>
			<input type="checkbox" r:context="accessories" r:name="accessoryTypes.${o.objid.toLowerCase()}" r:checkedValue="1" r:uncheckedValue="0"/>
			<span style="text-transform:capitalize;">${o.title}</span>
		</div>
	<%}%>
	<div style="padding-top:20px"></div>
	@wx:button( caption:'Next', context:'accessories', name:'saveAndContinue' )	
</div>	


<%if(hasItems == true ) {%>
<div r:context="accessories" r:visibleWhen="#{mode == 'view-list'}" style="display:none;">
	<% accessoryList.each { o-> %>
		<div style="padding-top:20px; text-transform:capitalize;">
			<b>${o.type.title}</b>
		</div>
		<% o.infos.each { x-> %>
			<div style="padding-left:20px">
				<label style="width:300px;font-weight:normal;text-transform:capitalize;">${x.caption.toLowerCase()} (${x.unit})</label>
				<input type="text" r:context="accessories" r:name="infoMap.${x.name.toLowerCase()}" r:datatype="${x.datatype}" style="width:100px"/>
			</div>	
		<%}%>
	<%}%>
	<div style="padding-top:20px"></div>
	@wx:button( caption:'Redo', context:'accessories', name:'redoSelection' )
	@wx:button( caption:'Next', context:'accessories', name:'saveAccesoryInfos' )

</div>
<%}%>
