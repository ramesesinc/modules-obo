<%
	def svc = SERVICE.lookup("OboMiscListService", "obo");
	def items = svc.getAccessoryOccupancyTypes();
	def infos = svc.getAccessoryInfos();	
%>


<script>
	\$put("accessories", new function() {
		var self = this;
		//load accessories
		var app = \$get("app").code;	
		this.mode;
		this.accessoryList;
		this.selectedItem;

		this.selectedAccessories = {};
		<%items.each { o-> %>
			self.selectedAccessories['${o.objid.toLowerCase()}'] = {checked: 0};	
		<%}%>
		this.infos = {};

		this.loadList = function() {
			self.accessoryList = app.service.getAccessories( {appid: app.appid } );
			if( self.accessoryList.length > 0 )  {
				for( var i = 0; i < self.accessoryList.length ; i++) {
					var v = self.accessoryList[i];
					self.selectedAccessories[ v.type.objid.toLowerCase() ].checked = 1;
				}
				self.mode = "view-list";
			}
			else {
				self.mode = "select-accessory"
			}
		}

		this.onload = function() {
			self.loadList();
			app.updateStepNavbar();	
		}

		this.saveAndContinue = function() {
			var items = [];
			var deleted = [];
			for( var prop in this.selectedAccessories ) {
				if( this.selectedAccessories[prop].checked == 1 ) {
					items.push( prop );
				}
				else {
					deleted.push(prop);
				}
			}
			if( items.length > 0 ) {
				var p = {};
				p.appid = app.appid;
				p.items = items;
				p.deleted = deleted;
				app.service.saveAccessories( p );
				window.location.reload();
			}
			else {
				if( deleted.length > 0 ) {
					var p = {};
					p.appid = app.appid;
					p.items = [];
					p.deleted = deleted;
					app.service.saveAccessories( p );
				}
				app.moveNextStep();
			}
		}

		this.viewSelection = function() {
			self.mode = "select-accessory";	
		}

	});
</script>

<div r:context="accessories" r:visibleWhen="#{mode == 'select-accessory'}" style="display:none;">
	<p>Select accessory if there are any. If there are none just click Next to continue</p>
	<br>
	<%items.each {o-> %>
		<input type="checkbox" r:context="accessories" r:name="selectedAccessories.${o.objid.toLowerCase()}.checked" r:checkedValue="1" r:uncheckedValue="0"/>&nbsp;&nbsp;${o.title}<br>
		<%}%>
	<br>
	<br>
	@wx:button( caption:'Next', context:'accessories', name:'saveAndContinue' )
</div>	

<div r:context="accessories" r:visibleWhen="#{mode == 'view-list'}" style="display:none;">
	<legend>Accessories</legend>
	<table r:context="accessories" r:items="accessoryList" r:varName="item" r:name="selectedItem" style="width:100%" class="customtable" 
		cellpadding="0" cellspacing="0">
		<thead>
			<tr>
				<td class="ap-permit">Type</td>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td class="ap-permit">#{item.type.title}</td>
			</tr>	
		</tbody>
	</table>
	<br>
	@wx:button( caption:'Select Accessory', context:'accessories', name:'viewSelection' )
</div>

