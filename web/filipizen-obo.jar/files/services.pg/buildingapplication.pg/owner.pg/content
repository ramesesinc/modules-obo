<script type="text/javascript">
\$put("owner", new function(){
	var self = this;
	this.mode = "initial";
	this.error;
	this.idno;
  this.barangayList;
  this.barangayid;
  this.owner;

	var app = \$get("app").code;
  var appSvc = Service.lookup( 'OnlineBuildingApplicationService', 'obo' );

	this.findOwner = function(){
		var profileSvc = Service.lookup( app.orgcode + ':RemoteEntityProfileService' );
		var p = {idno: self.idno };
		profileSvc.findByIdno( p, function(o,s) {
	      if( s == "error" ) {
	        self.error = o.result;
	      }
	      else {
	      	self.owner = o.result;
	        self.error = null;		
			    self.mode = "show-owner";
	      }
	      self._controller.refresh(); 
	    });
	};

	this.editOwner = function() {
		self.mode = "edit-owner";
	}

	this.retry = function() {
		self.error = null;
		self.mode = "initial";
	}

	this.saveOwner = function() {
		self.owner.appid = app.appid;
    self.owner.nextstep = "professional";
		app.service.saveOwner( self.owner );
		app.navigate( "professional" );
	}

  this.propertyChangeListener = {
    "barangayid" : function(o) {
      var bgy = {};
      for( var i =0; i<self.barangayList.length; i++ ) {
        if( self.barangayList[i].objid == o ) {
          bgy = self.barangayList[i];   
          break;
        }    
      }
      self.owner.address.barangay = bgy;  
      console.log(self.owner.address.barangay);
    },
    "owner.resident": function(o) {
      if(o == 0) {
        self.barangayid = null;
        self.owner.address.barangay.objid = null;
      }
      else {
        self.owner.address.city = null;
        self.owner.address.municipality = null;
        self.owner.address.province = null;        
      }    
    }  
  }

  this.onload = function() {
    this.owner = appSvc.getOwner( {appid: app.appid} );
    var bsvc = Service.lookup("CloudPartnerService", "partner");
    this.barangayList = bsvc.getBarangayList( {orgcode: app.orgcode} );
    if(!this.owner) {
      this.owner = {address:{barangay:{}}, resident:1, ctc:{}};
      self.mode = "initial";
    }
    else {
      self.mode = "edit-owner";
      if(this.owner.address.barangay.objid !=null) this.barangayid = this.owner.address.barangay.objid 
    }         
  }


});

 
</script>

<style>
  .form-horizontal .control-label {
    width: 18%;
  }
</style>
<br>
<br>
<legend>Building Owner Details</legend>
<div r:context="owner" r:visibleWhen="#{error != null }">
	<label r:context="owner" style="color:red;">#{error}</label>
</div>

<div r:context="owner" r:visibleWhen="#{mode=='initial'}" style='display:none'>
	<div class="row">
	    <div class="col-md-4">
	      <div class="control-group">
	        <label class="control-label">Enter the Owner Entity ID No and click Search</label>
	          <div class="form-group">
	            <input type="text" class="form-control input-response" r:context="owner" r:name="idno" r:textcase="none" 
	            placeholder="Enter Unique ID No registered provided by the LGU">
	          	<input type="submit" r:context="owner" r:name="findOwner" class="btn btn-submit btn-primary" value="Search">	            
	          </div>
	      </div>
	    </div>      
  	</div>
  	
	Forgot registration? <a href="/zz/entity/profilerecovery" target="owner">Click here</a>. <br>
	Register this owner as new entity? <a r:context="owner" r:name="editOwner">Click here</a>
</div>

<div r:context="owner" r:visibleWhen="#{mode=='edit-owner'}" style="display:none">
  <p>Please fill in the necessary data below. Text marked with * are required fields. </p>
      <br>
        <form class="form-horizontal"> 
        @obo:entityform( context:'owner', object: 'owner' ) 
        </form>
      <br>
      <div class="form-group">
        <label class="control-label col-sm-3"></label>
        <div class="col-md-8"><input type="submit" r:context="owner" r:name="saveOwner" 
        	class="btn-response btn btn-submit btn-primary" value="Next">
        </div>
      </div>               
</div>

<div r:context="owner" r:visibleWhen="#{mode=='show-owner'}" style='display:none'>
	<label>Please confirm if information is correct.</label>
	<div class="verify-info">
        <div class="col-md-12">
          <div class="row">
              <dl class="dl-horizontal">
              	<dt>ID No:</dt>
                <dd>: <label r:context="owner">#{owner.idno}</label></dd>
              	<dt>LGU Entity No:</dt>
                <dd>: <label r:context="owner">#{owner.entityno}</label></dd>
                <dt>First Name </dt>
                <dd>: <label r:context="owner">#{owner.firstname}</label></dd>
                <dt>Last Name </dt>
                <dd>: <label r:context="owner">#{owner.lastname}</label></dd>
                <dt>Middle Name</dt>
                <dd>: <label r:context="owner">#{owner.middlename}</label></dd>
                <dt>Address</dt>
                <dd>: <label r:context="owner">#{owner.address.text}</label></dd>
              </dl>

              <br>
              <button r:context="owner" r:name="retry" class="btn btn-submit btn-primary">Retry Search</button>&nbsp;
              <button r:context="owner" r:name="saveOwner" class="btn btn-submit btn-primary">Next</button>
          </div>
        </div>
    </div>
</div>






