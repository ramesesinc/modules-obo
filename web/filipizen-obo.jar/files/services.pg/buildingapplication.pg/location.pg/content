

<script type="text/javascript">
\$put("location", new function(){
	var self = this;
	this.mode = "initial";
	this.refno = "01-0059-00657";
  this.prop;
  this.locations;
  this.searchtype = "tdno";
  this.selectedItem;
  this.editmode;

	var app = \$get("app").code;

  this.appid = app.appid;

  this.findProperty = function() {
    var svc = Service.lookup( app.orgcode + ":OboOnlineService" );
    svc.findLocation( {refno: self.refno}, function(o,s) {
      if( s == "error" ) {
        alert("Error " + o.result);
      }
      else {
        self.mode = "view-lot";
        self.prop = o.result;
        if(self.prop.owner.address.type == 'local' ) {
          self.prop.owner.resident = 1;
        }
        else {
          self.prop.owner.resident = 0;
        }
        if( self.prop.owner.address.city ) self.prop.owner.address.citymunicipality = self.prop.owner.address.city;
        if( self.prop.owner.address.municipality ) self.prop.owner.address.citymunicipality = self.prop.owner.address.municipality;        
        self.prop.owner.ctc = {};      //allocate ctc
        self.prop.lotowned = null;
        self._controller.refresh();
      }
    });
  }

  this.reloadList = function() {
    self.locations = app.service.getLocations( {appid: app.appid} );
  }

  this.onload = function() {
    //check if there is a location set.
    self.reloadList();
    if( self.locations.length > 0) {
      self.mode = "view-locations";
    }
    else {
      self.editmode = "edit";
      self.mode = "initial";
    }
    app.updateStepNavbar();
  }

  this.viewInitial = function() { self.editmode = "edit"; self.mode = "initial";}
  this.editOwnerInfo = function() {self.mode = "edit-owner-info"; }
  this.viewList = function() {  
    self.reloadList();
    self.mode = 'view-locations'; 
  }

  this.saveLocation = function() {
    if(self.prop.lotowned == null ) {
      alert("Please specify if lot owner is the same as the building owner");
      return;
    }  
    self.prop.appid = app.appid;
    var u = app.service.saveLocation( self.prop );
    self.reloadList();
    self.mode = 'view-locations';
  }

  this.moveNextStep = function() {
    app.moveNextStep(  {appid: app.appid } );
  }

  this.attachId = function() {
    var h = function(v) {
      self.prop.owner.id = v;
      self._controller.refresh();
    }
    return new PopupOpener( "id_entry", { onselect: h, entry: self.prop.owner.id },  {width:'500', title:'Select Proof of Identity'} );
  }

  this.viewInfo = function() {
    if(!self.selectedItem) throw new Error("Please select an item");
    self.prop = self.selectedItem;
    self.mode = "view-lot";
    self.editmode = "view";
  }

});

\$register( {id:'id_entry',  page:"${PAGE.parentPath}/id_entry", context: 'id_entry' } );
</script>


<style>
  .form{width:100%; height:100%;padding-bottom:20px;}
  .section{float:left;display:inline-block;}
  .pl10 { padding-left:20px; }
  .output-class { font-weight:normal;}
  .input-class { font-weight:normal;}  
  .caption-class {width:150px;}
  .attachId { color:blue; }
</style>

<div r:context="location" r:visibleWhen="#{mode=='initial'}" style='display:none'>
  <div class="subtitle">Specify the Site Location/Property</div>
  <div class="form">
    <p>Select Search Type</p>
    <div><input type="radio" r:context="location" r:name="searchtype" value="tdno">&nbsp;By Tax Declaration No</div>
    @wx:text( caption:'Tax Declaration No.', context:'location', name:'refno', captionClass:'+w100 pl10' )
    <div style="font-weight:lighter"><input type="radio" r:context="location" r:name="searchtype" value="pin">&nbsp;By Property Index No</div>
    <div style="font-weight:lighter"><input type="radio" r:context="location" r:name="searchtype" value="lotno">&nbsp;By Lot No</div>
    <div style="font-weight:lighter;padding-bottom:5px;"><input type="radio" r:context="location" r:name="searchtype" value="titleno">&nbsp;By Lot Title No</div>
  </div>
  @wx:button( context:'location', name:'viewList', caption: 'Back to List', visibleWhen:'#{locations.length > 0 }' )
  @wx:button( context:'location', name:'findProperty', caption: 'Search' )
</div>

<div r:context="location" r:visibleWhen="#{mode=='view-lot'}" style='display:none'>
    <p>Please check carefully if the information is correct. If not, please contact the assessor's office before proceeding.<br>
    <label r:context="location">
      <a href="mailto:assessor@filipizen.com?subject=Building Application Inquiry No: #{appid}">[Click Here to Send Message] </a></p>
    </label>
    <br>
    <div class="form">
      <h2>Lot Information</h2>
      <div>
        @wx:label( caption:'PIN', context:'location', expr:'#{prop.pin}' )
        @wx:label( caption:'Lot No', context:'location', expr:'#{prop.lotno}')
        @wx:label( caption:'Block No', context:'location', expr:'#{prop.blockno}')
        @wx:label( caption:'Street', context:'location', expr:'#{prop.street}' )
        @wx:label( caption:'Barangay', context:'location', expr:'#{prop.barangay}' )
        @wx:label( caption:'Area &#40;Sqm&#41;', context:'location', expr:'#{prop.areasqm}' )
        @wx:label( caption:'TD No', context:'location', expr:'#{prop.tdno}')
        @wx:label( caption:'TCT No', context:'location', expr:'#{prop.tctno}' )
        @wx:label( caption:'Title No', context:'location', expr:'#{prop.titleno}' )
        @wx:label( caption:'Class Code', context:'location', expr:'#{prop.classcode}' )
      </div>
     <hr> 
     <h2>Lot Owner Information</h2>
     <div>
          @wx:label( caption:'Profile No', context:'location', expr:'#{prop.owner.profileno}' )    
          @wx:label( caption:'Profile Type', context:'location', expr:'#{prop.owner.entitytype}' )
          <div r:context="location" r:visibleWhen="#{prop.owner.entitytype != 'INDIVIDUAL' }">
            @wx:label( caption:'Lot Owner', context:'location', expr:'#{prop.owner.name}')
          </div>
          <div r:context="location" r:visibleWhen="#{prop.owner.entitytype == 'INDIVIDUAL' }">
            @wx:label( caption:'Last Name', context:'location', expr:'#{prop.owner.lastname}' ) 
            @wx:label( caption:'First Name', context:'location', expr:'#{prop.owner.firstname}' )
            @wx:label( caption:'Middle Name', context:'location', expr:'#{prop.owner.middlename}')
            @wx:gender( context:'location', expr:'#{prop.owner.gender}', readonly:true)            
          </div>
          @wx:address_nonlocal( caption:'Address', context:'location', name:'prop.owner.address', readonly:true)
      </div>
    </div> 

    <div r:context="location" r:visibleWhen="#{prop.bill!=null && prop.bill.amtdue > 0 }">
      <label r:context="location" style="color:red;font-weight:bold;">
        Note: There is still an unpaid balance of <u>Php #{prop.bill.amtdue}</u>.
        You can settle this by paying online <a  href="/partners/${PARAMS.name}/services/rptis/billing#viewbill?refno=#{refno}" target="0">here</a>
      </label>
    </div>
    @wx:button( context:'location', name:'viewInitial', caption: 'Back', visibleWhen:'#{editmode == \'edit\' }'  )
    @wx:button( context:'location', name:'editOwnerInfo', caption: 'Next' , visibleWhen:'#{editmode == \'edit\' }')
    @wx:button( context:'location', name:'viewList', caption: 'Back', visibleWhen:'#{editmode == \'view\' }' )
</div>

<div  r:context="location" r:visibleWhen="#{mode=='edit-owner-info'}" style='display:none'> 
  <h2>Lot Owner Details</h2>
  <p>Please update the information if necessary</p>
  <div class="form">
    @wx:label( caption:'Profile No', context:'location', expr:'#{prop.owner.profileno}', captionClass:'+w200' )    
    @wx:label( caption:'Name', context:'location', expr:'#{prop.owner.name}' , captionClass:'+w200')    
    @wx:email( context:'location', name:'prop.owner.email', inputClass: '+w200', captionClass:'+w200')
    @wx:mobile(context:'location', name:'prop.owner.mobileno', inputClass: '+w200', captionClass:'+w200' )
    @wx:idproof( context:'location', name:'prop.owner.id', action:'attachId' )
  </div>

  <div style="padding-bottom:20px">
  Is the Lot owner also the applicant?
  <input type="radio" r:context="location" r:name="prop.lotowned" value="1">&nbsp;Yes &nbsp;&nbsp;
  <input type="radio" r:context="location" r:name="prop.lotowned" value="0">&nbsp;No &nbsp;&nbsp;
  </div> 
  @wx:button( context:'location', name:'viewOwner', caption: 'Back' )   
  @wx:button( context:'location', name:'saveLocation', caption: 'Next' )
</div>

<div  r:context="location" r:visibleWhen="#{mode=='view-locations'}" style='display:none'>
  <h2>Locations</h2>
  <table r:context="location" r:items="locations" r:varName="item" border="1" r:name="selectedItem">
    <thead>
      <tr>
        <td>TD No</td>
        <td>Title No</td>        
        <td>PIN</td>
        <td>Lot No</td>
        <td>Block No</td>
        <td>Street</td>
        <td>Barangay</td>
        <td>Class</td>
        <td>Area (sqm)</td>        
        <td>Owner</td>
        <td>Owners address</td>
        <td>&nbsp;</td>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>#{item.tdno}</td>
          <td>#{item.titleno}</td>        
          <td>#{item.pin}</td>
          <td>#{item.lotno}</td>
          <td>#{item.blockno}</td>
          <td>#{item.street}</td>
          <td>#{item.barangay}</td>
          <td>#{item.classcode}</td>
          <td>#{item.areasqm}</td>        
          <td>#{item.owner.name}</td>
          <td>#{item.owner.address.text}</td>        
          <td>
            <a href="#" r:context="location" r:name="viewInfo">View</a> 
          </td>
        </tr>
    </tbody>
  </table>  
  <br>
  <br>

  @wx:button( context:'location', name:'viewInitial', caption: 'Add More Lots')
  @wx:button( context:'location', name:'moveNextStep', caption: 'Next' )
  

</div>
