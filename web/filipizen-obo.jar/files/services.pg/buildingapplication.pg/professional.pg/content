<script type="text/javascript">
\$put("prof", new function() {
	var self = this;
	this.mode = "view-list";
	this.error;
	this.idno;
	this.prof = {};
  this.selectedItem;

  this.barangayid;
  this.barangayList;

  var app = \$get("app").code;

	this.professions = ["ARCHITECT", "CIVIL ENGINEER", "ELECTRICAL ENGINEER", "MECHANICAL ENGINEER"];

  this.init = function() {
    self.prof = {}; 
    self.mode = "initial";
  } 

  this.findId = function(){
      self.error = "Name not found. Please try again";
  };

  this.initNewEntry = function() {
    self.error = null;
    self.mode = "add-entry";
    self.prof = { address: {}, resident: 1, ctc: {} };
  }

  this.addNewEntry = function() {
    self.prof.appid = app.appid;
    app.service.saveProfessional( self.prof );
    self.prof = {};
    self.mode = "view-list";
  }

  this.finish = function() {
    app.service.updateNextStep( {appid: app.appid, step:'project'} );
    app.navigate( "project" );
  }

  this.getProfessionals = function(){
    return app.service.getProfessionalList({appid: app.appid });    
  }

  this.removeItem = function() {
    if(!this.selectedItem) throw new Exception("Please select an item");
    var b = confirm("You are about to remove this entry. Proceed?");
    if( b ) {
      app.service.removeProfessional( {objid: this.selectedItem.objid } );
      self._controller.refresh();
    }
  }

  this.propertyChangeListener = {
    "barangayid" : function(o) {
      var bgy = {};
      for( var i =0; i<self.barangayList.length; i++ ) {
        if( self.barangayList[i].objid == o ) {
          bgy = self.barangayList[i];   
          break;
        }    
      }
      self.prof.address.barangay = bgy;  
    },
    "prof.resident": function(o) {
      if(o == 0) {
        self.barangayid = null;
        self.prof.address.barangay.objid = null;
      }
      else {
        self.prof.address.city = null;
        self.prof.address.municipality = null;
        self.prof.address.province = null;        
      }    
    }  
  }

  this.onload = function() {
    var bsvc = Service.lookup("CloudPartnerService", "partner");
    this.barangayList = bsvc.getBarangayList( {orgcode: app.orgcode} );
  }


});
</script>


<br>
<br>
<legend>List of Licensed Professionals</legend>

<div r:context="prof" r:visibleWhen="#{error != null }">
	<label r:context="prof" style="color:red;">#{error}</label>
</div>

<div r:context="prof" r:visibleWhen="#{mode=='initial'}">
	<p>Specify technical persons involved who will require signature on the project (e.g. architect, civil engineer, etc):</p> 

	<div class="row">
	    <div class="col-md-4">
	      <div class="control-group">
	        <label class="control-label">Enter PRC No</label>
	          <div class="form-group">
	            <input type="text" class="form-control input-response" r:context="prof" r:name="idno" r:textcase="none" 
	            placeholder="Enter PRC No">
	          	<input type="submit" r:context="prof" r:name="findId" class="btn btn-submit btn-primary" value="Search">	            
	          </div>
	      </div>
	    </div>      
  	</div>
  	Register this professional? <a href="#" r:context="prof" r:name="initNewEntry">Click here</a>
</div>


<div r:context="prof" r:visibleWhen="#{mode=='view-entry'}">
	<p>Please check if the details of the professional is correct. Click Add if OK</p> 
	<div class="verify-info">
        <div class="col-md-12">
          <div class="row">
              <dl class="dl-horizontal">
              	<dt>PRC No:</dt>
                <dd>: <label r:context="prof">#{prof.prcno}</label></dd>
                <dt>First Name </dt>
                <dd>: <label r:context="prof">#{prof.firstname}</label></dd>
                <dt>Last Name </dt>
                <dd>: <label r:context="prof">#{prof.lastname}</label></dd>
                <dt>Middle Name</dt>
                <dd>: <label r:context="prof">#{prof.middlename}</label></dd>
                <dt>Address</dt>
                <dd>: <label r:context="prof">#{prof.address.text}</label></dd>
              </dl>

              <br>
              <input type="submit" r:context="prof" r:name="addNewEntry" class="btn btn-submit btn-primary" value="Add To List" />
          </div>
        </div>
    </div>
</div>


<div r:context="prof" r:visibleWhen="#{mode=='add-entry'}" style="display:none">
  <p>Please fill in the necessary data below. Text marked with * are required fields. </p>
  <br>

  <form class="form-horizontal"> 

  <div class="row">
    <div class="col-md-8">  
      <div class="form-group">
        <label class="control-label col-sm-3">Profession <span class="text-danger">*</span></label>
        <div class="col-md-8 col-sm-9">
          <select r:context="prof" r:name="prof.profession" r:items="professions" required="true"
           r:emptyText="Select Profession" r:allowNull="true" r:emptyText="Select Profession"></select>
        </div>
      </div>
    </div>
  </div>    

  @obo:entityform( context:'prof', object: 'prof' ) 
 
  <br>
  <div class="form-group">
    <label class="control-label col-sm-3"></label>
    <div class="col-md-8"><input type="submit" r:context="prof" r:name="addNewEntry" 
    	class="btn-response btn btn-submit btn-primary" value="Add To List"></div>
  </div>               

</div>

<div  r:context="prof" r:visibleWhen="#{mode == 'view-list'}">
  <label class="control-label">List of Professionals</label>
  <table r:context="prof" r:items="getProfessionals()" r:varName="item" r:name="selectedItem" border="1px">
    <thead>
      <tr>
        <td>PRC No</td>
        <td>Profession</td>        
        <td>Last Name</td>
        <td>First Name</td>
        <td>Middle Name</td>
        <td>Address</td>
        <td>&nbsp;</td>        
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>#{item.prc.refno}</td>
        <td>#{item.profession}</td>        
        <td>#{item.lastname}</td>
        <td>#{item.firstname}</td>
        <td>#{item.middlename}</td>
        <td>#{item.address.text}</td>
        <td>
          <a href="#" r:context="prof" r:name="removeItem">Remove</a> 
        </td>
      </tr>
    </tbody>
  </table>
  <br>
  <input type="submit" r:context="prof" r:name="init" class="btn btn-submit btn-primary" value="Add Entry"> 
  <input type="submit" r:context="prof" r:name="finish" class="btn btn-submit btn-primary" value="Next">  

</div>

