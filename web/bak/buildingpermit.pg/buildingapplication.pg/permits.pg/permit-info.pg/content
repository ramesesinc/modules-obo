<%
	def PGFILE;
	if (PARAMS.code) {
		PGFILE = ANUBIS.getFile( "${PAGE.parentPath}/" + PARAMS.code.toLowerCase() + ".pg");
	}
	if (!PGFILE) PGFILE = [title: ''];
%>

<script>
	\$register( {
		id:"facilities", 
		context: "facilities", 
		page: "/partners/${PARAMS.name}/services/buildingpermit/buildingapplication/facilities", 
		title:"Select Facilities" 
	} );

	\$register({
		id: "edit-professional",
		context: "edit-professional",
		page: "/popup/edit-professional",
		title: "Edit Professional"
	});

	var controller = new function() {
		var self = this;
		var oboSvc = Service.lookup("TestOboService", "default");

		this.data;
		this.prevdata;
		this.scope;
		this.removeitemid;
		this.proftype;

		this.onload = function() {
			self.data = oboSvc.getSubapplication({objid: "${PARAMS.subappid}"});
			if (self.data.application) {
				self.scope = self.data.application.scope.join(",");
			}

			if ("${PGFILE.showdesignprofessional}" == "true") {
				\$("#designprofessional-content").removeClass("hide");
			}
			if ("${PGFILE.showsupervisor}" == "true") {
				\$("#supervisor-content").removeClass("hide");
			}

			\$("#permit-main-container input[type=text]").attr("readonly", "readonly");

			self.mode = 'read';
			self.buildPermitContent();

			var selector = '#UploadFile';
			selector = '.file-upload';
			FilipizenUtil.fileUploadChangeEventListener(selector, function() {
				console.log('my change function');
				var id = \$(this).attr('id');
				if (id) {
				  \$('#' + id + '-filename').val(this.value.substring(12));
				}
			});
		}

		this.back = function() {
			if (window.history) {
				window.history.back();
			}
		}

		this.editProfessional = function() {
			var type = self.proftype;
			var handler = function( o ) {
				var params = {subappid: self.data.objid, professional: o, type: type}
				var prof = oboSvc.saveProfessional(params);
				if (type == 'design') {
					self.data.designprofessional = prof;
      				BindingUtils.bind(null, "#designprofessional-content");
				} else if (type == 'supervisor') {
					self.data.supervisor = prof;
      				BindingUtils.bind(null, "#supervisor-content");
				}
			}
	        var params = {callbackHandler: handler, data: {}}
	        if (type == 'design') {
	        	params.data = FilipizenUtil.copyObject( self.data.designprofessional );
	        } else if (type == 'supervisor') {
	        	params.data = FilipizenUtil.copyObject( self.data.supervisor );
	        }

	        return new PopupOpener ("edit-professional", params, {width:700 , height: 550});
		}

		this.getHeaders = function( src ) {
			var list = [];
			if (src) {
				var hd = ["description", "value", "unit"];
				for (var i=0; i<hd.length; i++) {
					var key = hd[i];
					var flag = false;
					var item = {key: key};
					for (var j=0; j<src.length; j++) {
						var x = src[j]
						if (x[key]) {
							var c = FilipizenUtil.findItem( list, item, "key");
							if (!c) {
								flag = true;
								break;
							}
						}
					}
					if (flag == true) {
						if (key == "description") {
							item.name = "description";
							item.value = "Description";
						}
						if (key == "value") {
							item.name = "value";
							item.value = "Value";
						}
						if (key == "unit") {
							item.name = "unit";
							item.value = "Unit";
						}
						list.push( item );
					}
				}
			}	
			return list;
		}

		this.buildPermitContent = function() {
			var html;
			var list = self.data.items;
			if (Array.isArray(list) && list.length > 0) {
				var sections = [];
				for (var i=0; i<list.length; i++) {
					var x = list[i];
					var item = FilipizenUtil.findItem( sections, {caption: x.category}, "caption");
					if (!item) {
						item = {
							caption: x.category,
							sortorder: x.sortorder
						}
						sections.push( item );
					}
					sections = FilipizenUtil.sortByKey(sections, "sortorder");
				}

		        html = "<table style='width:100%'>";
				for (var i=0; i<sections.length; i++) {
					var s = sections[i];
					if (s) {
						html += "<tr>";
						html += "<td class='font16'>" + s.caption;
						var items = self.getSectionItems( list, s.caption );
						if (items && items.length > 0) {
							items = FilipizenUtil.sortByKey(items, "name");
				            html += "<table class='table' style='margin-left:15px; margin-right:15px;'>";

				            html += "<thead>";
		            		var headers = self.getHeaders( items );
				            for (var j=0; j<headers.length; j++) {
								var y = headers[j];
								if (y && y.value) {
									html += "<th scope='col'>" + y.value + "</th>";
								}
				            }

				            html += "</thead><tbody>";
				            for (var j=0; j<items.length; j++) {
								var y = items[j];
								html += "<tr>";
								for (var h=0; h<headers.length; h++) {
									var xh = headers[h];
									html += "<td>";
									if (xh && y[xh.name]) {
									  html += y[xh.name];
									}
									html += "</td>";
								}
								html += "<td width='10%'><a r:context='${PAGE.context}' r:name='removeItem' r:param_removeitemid='" + y.objid + "'><i class='fa fa-trash'></i></a></td>";
								html += "</tr>";
				            }
				            html += "</tbody></table>";
						}
						html += "</td>";
						html += "</tr>";
					}
				}

		        html += "</table><br/><br/><br/><br/><br/>";
			} else {
				html = "<br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>";
			}
	        var e = \$("#permit-content");
	        if (e != null) {
	          e.html( html );
	        }
		}

		this.getSectionItems = function( srclist, category ) {
			var list = [];
			if (srclist) {
				for (var i=0; i<srclist.length; i++) {
					var x = srclist[i];
					if (x && x.category == category) {
						list.push( x );
					}
				}
			}
			return list;
		}

		this.getValues = function( list ) {
			var values = {};
			if (list) {
				list.forEach(function( itm ) {
					var i = FilipizenUtil.findItem(self.data.items, {name: itm.objid}
						, "name");
					if (i && i.value) values[itm.objid] = i.value;
				});
			}
			return values;
		}

		this.getActive = function( list ) {
			var active = {};

			if (list) {
				for (var i=0; i<list.length; i++) {
					var x = list[i];
					if (x) {
						var val = "unchecked";
						var item = FilipizenUtil.findItem( self.data.items, {name: x.objid}, "name");
						if (item) {
							val = "checked";
						}
						active[x.objid] = val;
					}
				}
			}
			return active;
		}

		this.addItems = function() {
	        var list = oboSvc.getVariablesBySection({sectionid: self.data.sectionid});
	        var handler = function( items ) {
	        	if (items) {

	        		items.forEach(function( itm, idx ) {
	        			if (itm.objid) {
	        				if (itm.allowadd) {
			        			var o = FilipizenUtil.findItem( self.data.items, {objid: itm.objid}, "objid" );
			        			if (!o) {
			        				self.data.items.push( itm );
			        			}
	        				}
	        				if (itm.allowremove) {
	        					FilipizenUtil.removeItem(self.data.items, {objid: itm.objid}, "objid");
	        				}
	        			}
	        		});
	        	}
	        	var params = {
	        		subappid: self.data.objid,
	        		list: self.data.items
	        	}
	        	self.data.items = oboSvc.saveSubapplicationItems(params);
	        	self.buildPermitContent();
	        }

	        var params = {
	        	callbackHandler: handler,
	        	list: list,
	        	active: self.getActive( list ),
	        	values: self.getValues( list ),
	        	items: self.data.items
	        }

	        return new PopupOpener ("facilities", params, {width:500,height: 400});
		}

		this.removeItem = function() {
			if (!self.removeitemid) return;
			oboSvc.removeSubapplicationItem({objid: self.removeitemid});
			self.data.items = oboSvc.getSubapplicationItems({subappid: self.data.objid});
			//FilipizenUtil.removeItem(self.data.items, {objid: self.removeitemid}, "objid");
			self.buildPermitContent();
		}

	}
	\$put( "${PAGE.context}", controller );
</script>
<div class="col-md-12">
	<div class="btn-bldgprev">
	  <button r:context="${PAGE.context}" r:name="back" r:visibleWhen="#{mode=='read'}" class="btn-bldg"><i class="fa fa-angle-double-left"></i> Previous 
	  </button>
	</div>
</div>
<br>


<!--<input type="button" value="Back" class="btn btn-primary" r:context="${PAGE.context}" r:name="back" r:visibleWhen="#{mode=='read'}" />

<input type="button" value="Cancel" class="btn btn-primary" r:context="${PAGE.context}" r:name="cancel" />
<input type="button" value="Edit" class="btn btn-primary" r:context="${PAGE.context}" r:name="edit" />
<input type="button" value="Save" class="btn btn-primary" r:context="${PAGE.context}" r:name="save" />
<input type="button" value="Print" class="btn btn-default" style="float:right" r:context="${PAGE.context}" r:name="print" r:visibleWhen="#{mode=='read'}" /> -->

<div id='permit-main-container' class='container col-md-12' style='margin-top:20px;'>
	<div class="row">
		<div class='col-md-6 panel-heading'>
			<label style='font-size:30px; font-weight:bold;'>${PGFILE.title} Permit</label>
		</div>
		<div class="col-md-6 text-right">
			<button type="button" class="btn btn-default" r:context="${PAGE.context}" r:name="print" ><i class="fa fa-print"></i> Print</button>
		</div>
	</div>
	
	<br/><br/>
	<h2>Application Information</h2>
	<div style='border:1px solid #dadada;'>
		<div class="panel-body">
			<div class="row">
				<div class="col-md-12">
                            <div class="row">
                              <div class="col-md-6">
                                <dl class="dl-horizontal">
                                  <dt>Application Type :</dt>
                                  <dd><label r:context="${PAGE.context}" r:name="data.application.apptype"></label></dd>
                                  <dt>Tracking No. :</dt>
                                  <dd><label r:context="${PAGE.context}" r:name="data.application.controlno"></label></dd>
                                  <dt>Owner :</dt>
                                  <dd><label r:context="${PAGE.context}" r:name="data.application.owner.name"></label></dd>
                                  <dt>Scope of Work  :</dt>
                                  <dd><label r:context="${PAGE.context}" r:name="scope"></label></dd>
                                  <dt>Occupancy Classification</dt>
                                  <dd><label r:context="${PAGE.context}" r:name="data.application.classification.title" ></label></dd>
                                  <dt>Use or Character of Occupancy :</dt>
                                  <dd><label r:context="${PAGE.context}" r:name="data.application.occupancyuse.description"></label></dd>
                                </dl>
                              </div>      
                              <div class="col-md-6">
                                <dl class="dl-horizontal">
                                  <dt>No. of Units :</dt>
                                  <dd><label r:context="${PAGE.context}" r:name="data.application.units"></label></dd>
                                  <dt>Total Floor Area (sqm) :</dt>
                                  <dd><label r:context="${PAGE.context}" r:name="data.application.floorarea"></label></dd>
                                  <dt>Total Estimated Cost</dt>
                                  <dd><label r:context="${PAGE.context}" r:name="data.application.estimatedcost"></label></dd>
                                  <dt>Proposed Date of Const</dt>
                                  <dd><label r:context="${PAGE.context}" r:name="data.application.dtproposedconstruction"></label></dd>
                                  <dt><b>Expected Comp. Date</dt>
                                  <dd><label r:context="${PAGE.context}" r:name="data.application.dtexpectedcompletion"></label></dd>
                                </dl>
                                <div id="ctcexpired"  class="hide expiredMsg">
                                  <p><i>Your CTC is expired. </i><a href="/partners/${PARAMS.name}/services/e-cedula/ctcform?ctcno=${PARAMS.ctcno}" class="active-link">Renew CTC No.</a></p>
                                </div>
                              </div>
                            </div> 
                          </div> 
			</div>
		</div>
	</div>
	<br/><br/>
	<h2>Specify Details</h2>
	<div style='border:1px solid #dadada;'>
		<br/>
		<div class="col-md-2" >
			<button class="thumbnail btn btn-primary" r:context="${PAGE.context}" r:name="addItems" >Add items</button>
		</div>
		<br/>
		<div id="permit-content" style="margin:10px;"></div>
	</div>
	<br/><br/>
	<h2>Professional</h2>
	<div style='border:1px solid #dadada;'>
		<div id="designprofessional-content" class="hide">
			<div class="col-md-12 row">
				<div class="panel-body panel-table-body">
					@box2(title:'Design Professional', name: "data.designprofessional", proftype:'design', editfunc: 'editProfessional')
				</div>
			</div>
		</div>
		<div id="supervisor-content" class="hide">
			<div class="col-md-12 row">
				<div class="panel-body panel-table-body">
					@box2(title: 'Supervisor', name: "data.supervisor", proftype:'supervisor', editfunc: 'editProfessional')
				</div>
			</div>
		</div>
	</div>

	<br/><br/>
	<h2>Requirements</h2>
	<div style='border:1px solid #dadada;'>	
		<div class="col-md-12">
			<div class="panel panel-default panel-table">
				<div class="panel-body">
					<!--
					<div class="main-img-preview">
						<img class="thumbnail img-preview" src="" title="Preview">
					</div>
					-->
					<div class="form-group row">
						<div class="col-md-2">
							<label><b>Requirement 1 </b></label>
						</div>
						<div class="col-md-2">
							<div class="fileUpload">
								<span><i class="fa fa-paperclip"></i> Attch File</span> 
								<input id="uf1" type="file" class="file-upload">
							</div>
						</div>
						<div class="col-md-6">
							<input id="uf1-filename" class="fileName" disabled="disabled">
						</div>
					</div> 
					<div class="form-group row">
						<div class="col-md-2">
							<label><b>Requirement 2 </b></label>
						</div>
						<div class="col-md-2">
							<div class="fileUpload">
								<span><i class="fa fa-paperclip"></i> Attch File</span> 
								<input id="uf2" type="file" class="file-upload">
							</div>
						</div>
						<div class="col-md-6">
							<input id="uf2-filename" class="fileName" disabled="disabled">
						</div>
					</div> 
					<div class="form-group row">
						<div class="col-md-2">
							<label><b>Requirement 3 </b></label>
						</div>
						<div class="col-md-2">
							<div class="fileUpload">
								<span><i class="fa fa-paperclip"></i> Attch File</span> 
								<input id="uf3" type="file" class="file-upload">
							</div>
						</div>
						<div class="col-md-6">
							<input id="uf3-filename" class="fileName" disabled="disabled"/>
						</div>
					</div>                      
				</div>
			</div>
		</div>
	</div>
</div>
<br/><br/><br/>