<%
	def PGFILE;
	if (PARAMS.code) {
		PGFILE = ANUBIS.getFile( "${PAGE.parentPath}/" + PARAMS.code.toLowerCase() + ".pg");
	}
	if (!PGFILE) PGFILE = [:];
%>

<script>
	\$register( {
		id:"facilities", 
		context: "facilities", 
		page: "/partners/${PARAMS.name}/services/buildingpermit/buildingapplication/facilities", 
		title:"Select Facilities" 
	} );

	\$register({
		id: "edit-professional",
		context: "edit-professional",
		page: "/popup/edit-professional",
		title: "Edit Professional"
	});

	var controller = new function() {
		var self = this;
		var oboSvc = Service.lookup("TestOboService", "default");

		this.data;
		this.prevdata;
		this.removeitemid;
		this.proftype;
		this.mode = 'read';

		//this.list = [{objid: 1, title: "Hello1"}, {objid: 2, title: "Hello2"}, {objid: 3, title: "Hello3"}]

		this.onload = function() {
			self.data = oboSvc.getSubapplication({objid: "${PARAMS.subappid}"});

			if ("${PGFILE.showdesignprofessional}" == "true") {
				\$("#designprofessional-content").removeClass("hide");
			}
			if ("${PGFILE.showsupervisor}" == "true") {
				\$("#supervisor-content").removeClass("hide");
			}

			\$("#permit-main-container input[type=text]").attr("readonly", "readonly");

			self.mode = 'read';
			self.buildPermitContent();

			let selector = '#UploadFile';
		      selector = '.file-upload';
		      FilipizenUtil.fileUploadChangeEventListener(selector, function() {
		        console.log('my change function');
		        let id = \$(this).attr('id');
		        if (id) {
		          \$('#' + id + '-filename').val(this.value.substring(12));
		        }
		        //document.getElementById('FileName').value = this.value.substring(12);
		        FilipizenUtil.uploadFile(this);
		        console.log(FilipizenUtil.getFiles());
		      });

			console.log(FilipizenUtil.getFiles());
		}

		this.back = function() {
			if (window.history) {
				window.history.back();
			}
		}

		this.cancel = function() {
			self.data = self.prevdata;
			\$("#permit-main-container input[type=text]").attr("readonly","readonly");
			self.mode = "read";
			self.buildPermitContent();
		}

		this.edit = function() {
			self.prevdata = FilipizenUtil.copyObject( self.data );
			\$("#permit-main-container input[type=text]").removeAttr("readonly");
			self.mode = "edit";
		}

		this.save = function() {
			self.data = oboSvc.saveSubapplication( self.data );
			\$("#permit-main-container input[type=text]").attr("readonly","readonly");
			self.mode = "read";
		}

		this.editProfessional = function() {
			var type = self.proftype;
			var handler = function( o ) {
				if (type == 'design') {
					self.data.designprofessional = o;
      				BindingUtils.bind(null, "#designprofessional-content");
				} else if (type == 'supervisor') {
					self.data.supervisor = o;
      				BindingUtils.bind(null, "#supervisor-content");
				}
			}
	        var params = {callbackHandler: handler, data: {}}
	        if (type == 'design') {
	        	params.data = FilipizenUtil.copyObject( self.data.designprofessional );
	        } else if (type == 'supervisor') {
	        	params.data = FilipizenUtil.copyObject( self.data.supervisor );
	        }

	        return new PopupOpener ("edit-professional", params, {width:500 , height: 400});
		}

		this.getHeaders = function( src ) {
			var list = [];
			if (src) {
				var hd = ["description", "value", "unit"];
				for (var i=0; i<hd.length; i++) {
					var key = hd[i];
					var flag = false;
					var item = {key: key};
					for (var j=0; j<src.length; j++) {
						var x = src[j]
						if (x[key]) {
							var c = FilipizenUtil.findItem( list, item, "key");
							if (!c) {
								flag = true;
								break;
							}
						}
					}
					if (flag == true) {
						if (key == "description") {
							item.name = "description";
							item.value = "Description";
						}
						if (key == "value") {
							item.name = "value";
							item.value = "Value";
						}
						if (key == "unit") {
							item.name = "unit";
							item.value = "Unit";
						}
						list.push( item );
					}
				}
			}	
			return list;
		}

		this.buildPermitContent = function() {
			var list = self.data.items;
			if (list) {
				var sections = [];
				for (var i=0; i<list.length; i++) {
					var x = list[i];
					var item = FilipizenUtil.findItem( sections, {caption: x.category}, "caption");
					if (!item) {
						item = {
							caption: x.category,
							sortorder: x.sortorder
						}
						sections.push( item );
					}
					sections = FilipizenUtil.sortByKey(sections, "sortorder");
				}

		        var html = "<table style='width:100%'>";
				for (var i=0; i<sections.length; i++) {
					var s = sections[i];
					if (s) {
						html += "<tr>";
						html += "<td class='font16'>" + s.caption;
						var items = self.getSectionItems( list, s.caption );
						if (items && items.length > 0) {
							items = FilipizenUtil.sortByKey(items, "description");
				            html += "<table class='table' style='margin-left:15px; margin-right:15px;'>";

				            html += "<thead>";
		            		var headers = self.getHeaders( items );
				            for (var j=0; j<headers.length; j++) {
								var y = headers[j];
								if (y && y.value) {
									html += "<th scope='col'>" + y.value + "</th>";
								}
				            }

				            html += "</thead><tbody>";
				            for (var j=0; j<items.length; j++) {
								var y = items[j];
								html += "<tr>";
								for (var h=0; h<headers.length; h++) {
									var xh = headers[h];
									html += "<td>";
									if (xh && y[xh.name]) {
									  html += y[xh.name];
									}
									html += "</td>";
								}
								html += "<td width='10%'><a r:context='${PAGE.context}' r:name='removeItem' r:param_removeitemid='" + y.objid + "' r:visibleWhen='#{mode!=\\"read\\"}'>remove</a></td>";
								html += "</tr>";
				            }
				            html += "</tbody></table>";
						}
						html += "</td>";
						html += "</tr>";
					}
				}

		        html += "</table>";
		        var e = \$("#permit-content");
		        if (e != null) {
		          e.html( html );
		        }
			}
		}

		this.getSectionItems = function( srclist, category ) {
			var list = [];
			if (srclist) {
				for (var i=0; i<srclist.length; i++) {
					var x = srclist[i];
					if (x && x.category == category) {
						list.push( x );
					}
				}
			}
			return list;
		}

		this.getValues = function( list ) {
			var values = {};
			if (list) {
				list.forEach(function( itm ) {
					var i = FilipizenUtil.findItem(self.data.items, {name: itm.objid}
						, "name");
					if (i && i.value) values[itm.objid] = i.value;
				});
			}
			return values;
		}

		this.getActive = function( list ) {
			var active = {};

			if (list) {
				for (var i=0; i<list.length; i++) {
					var x = list[i];
					if (x) {
						var val = "unchecked";
						var item = FilipizenUtil.findItem( self.data.items, {name: x.objid}, "name");
						if (item) {
							val = "checked";
						}
						active[x.objid] = val;
					}
				}
			}
			return active;
		}

		this.addItems = function() {

	        var list = oboSvc.getVariablesBySection({sectionid: self.data.sectionid});

	        var handler = function( items ) {
	        	if (items) {

	        		items.forEach(function( itm, idx ) {
	        			if (itm.objid) {
	        				if (itm.allowadd) {
			        			var o = FilipizenUtil.findItem( self.data.items, {objid: itm.objid}, "objid" );
			        			if (!o) {
			        				self.data.items.push( itm );
			        			}
	        				}
	        				if (itm.allowremove) {
	        					FilipizenUtil.removeItem(self.data.items, {objid: itm.objid}, "objid");
	        				}
	        			}
	        		});
	        	}
	        	self.buildPermitContent();
	        }

	        var params = {
	        	callbackHandler: handler,
	        	list: list,
	        	active: self.getActive( list ),
	        	values: self.getValues( list ),
	        	items: self.data.items
	        }

	        return new PopupOpener ("facilities", params, {width:500 , height: 400});
		}

		this.removeItem = function() {
			if (!self.removeitemid) return;
			FilipizenUtil.removeItem(self.data.items, {objid: self.removeitemid}, "objid");
			self.buildPermitContent();
		}

	}
	\$put( "${PAGE.context}", controller );
</script>
<div class="col-md-12">
	<div class="btn-bldgprev">
	  <button r:context="${PAGE.context}" r:name="back" r:visibleWhen="#{mode=='read'}" class="btn-bldg"><i class="fa fa-angle-double-left"></i> Previous 
	  </button>
	</div>
</div>
<br>


<!--<input type="button" value="Back" class="btn btn-primary" r:context="${PAGE.context}" r:name="back" r:visibleWhen="#{mode=='read'}" />

<input type="button" value="Cancel" class="btn btn-primary" r:context="${PAGE.context}" r:name="cancel" />
<input type="button" value="Edit" class="btn btn-primary" r:context="${PAGE.context}" r:name="edit" />
<input type="button" value="Save" class="btn btn-primary" r:context="${PAGE.context}" r:name="save" />
<input type="button" value="Print" class="btn btn-default" style="float:right" r:context="${PAGE.context}" r:name="print" r:visibleWhen="#{mode=='read'}" /> -->

<div id="permit-main-container" class="container" style="margin-top: 20px;">
	<div class="col-md-12">
       <div class="panel-lot panel-default panel-table">
          <div class="panel-heading">
            <div class="row">
              <div class="col-md-8">
                <h1>${PGFILE.title} Permit</h1>
              </div>
              <div class="col-md-4 text-right">
                <button type="button" class="btn btn-primary" r:context="${PAGE.context}" r:name="cancel"><i class="fa fa-times"></i></button>
                <button type="button" class="btn btn-primary" r:context="${PAGE.context}" r:name="edit" >Edit</button>
                <button type="button" class="btn btn-primary" r:context="${PAGE.context}" r:name="save">Save</button>
                <button type="button" class="btn btn-default" r:context="${PAGE.context}" r:name="print" >Print</button>
              </div>
            </div>
          </div>
          <div class="panel-body">
				<div class="row">
					<div class="col-md-12">
						<p class="font16">Tracking No. : <label class="font16" r:context="${PAGE.context}" r:name="data.application.controlno"/></p>
						<p class="font16">Owner : <label class="font16" r:context="${PAGE.context}" r:name="data.application.owner.name" /></p>
						<!--
						<br>
						<p class="font16">Assign To : <label class="font16" r:context="${PAGE.context}" r:name="" /></p>
						-->
						<!--
						<ol r:context="${PAGE.context}" r:item="sections" r:varName="item">
						<li>#{item.title}</li>
						</ol>
						-->
						<br/>
						<div class="col-md-2" >
							<button class="thumbnail btn btn-primary" r:context="${PAGE.context}" r:name="addItems" >Add items</button>
						</div>
						<br/>
						<div id="permit-content" style="margin:10px;"></div>
						<br/>
						<div id="designprofessional-content" class="hide">
							<div class="col-md-12 row">
			                       <div class="panel panel-default panel-table">
			                          <div class="panel-heading">
			                            <div class="row">
			                              <div class="col col-md-10">
			                                <h3 class="panel-permitsHeader">Design Professional</h3>
			                              </div>
			                            </div>
			                          </div>
			                          <div class="panel-body">
										<% def editFunc = "editProfessional"; %>
										@box2(title:'Design Professional', name: "data.designprofessional", proftype:'design', editfunc: editFunc)
									</div>
								</div>
							</div>
						</div>
						<div id="supervisor-content" class="hide">
							<div class="col-md-12 row">
			                       <div class="panel panel-default panel-table">
			                          <div class="panel-heading">
			                            <div class="row">
			                              <div class="col col-md-10">
			                                <h3 class="panel-permitsHeader">Supervisor</h3>
			                              </div>
			                            </div>
			                          </div>
			                          <div class="panel-body">
										@box2(title: 'Supervisor', name: "data.supervisor", proftype:'supervisor', editfunc: "editProfessional")
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-md-12">
		   		<div class="panel panel-default panel-table">
			      <div class="panel-heading">
			        <div class="row">
			          <div class="col col-md-10">
			            <h3 class="panel-permitsHeader">Attach Document(s)</h3>
			          </div>
			        </div>
			      </div>
		      	<div class="panel-body">
		            <!--
		            <div class="main-img-preview">
		              <img class="thumbnail img-preview" src="" title="Preview">
		            </div>
		          -->
		            <div class="form-group row">
		                <div class="col-md-4">
		                  <label class="font16"><b>Document 1 </b></label>
		                </div>
		                <div class="col-md-2">
		                  <div class="fileUpload btn btn-primary">
		                    <span><i class="fa fa-paperclip"></i> Attch File</span> 
		                    <input id="uf1" type="file" class="file-upload">
		                  </div>
		                </div>
		                <div class="col-md-6">
		                  <input id="uf1-filename" class="fileName" disabled="disabled">
		                </div>
		            </div> 
		            <div class="form-group row">
		                <div class="col-md-4">
		                  <label class="font16"><b>Document 2 </b></label>
		                </div>
		                <div class="col-md-2">
		                  <div class="fileUpload btn btn-primary">
		                    <span><i class="fa fa-paperclip"></i> Attch File</span> 
		                    <input id="uf2" type="file" class="file-upload">
		                  </div>
		                </div>
		                <div class="col-md-6">
		                  <input id="uf2-filename" class="fileName" disabled="disabled">
		                </div>
		            </div> 
		            <div class="form-group row">
		                <div class="col-md-4">
		                  <label class="font16"><b>Document 3 </b></label>
		                </div>
		                <div class="col-md-2">
		                  <div class="fileUpload btn btn-primary">
		                    <span><i class="fa fa-paperclip"></i> Attch File</span> 
		                    <input id="uf3" type="file" class="file-upload">
		                  </div>
		                </div>
		                <div class="col-md-6">
		                  <input id="uf3-filename" class="fileName" disabled="disabled">
		                </div>
		            </div>                      
		      	</div>
		    </div>
		  </div> 
		</div>
	</div>
</div>               
