
<%if( PARAMS.error !=null) { %>
<pre>Error ${PARAMS.error?.message}</pre>
<% } %>
<script>
\$register( {
  id:"requirements", 
  context: "requirements",
  page: "/partners/${PARAMS.name}/services/buildingpermit/buildingapplication/permitrequirements", 
  title:"Select Permits to apply"
} );

\$put("app", new function(){
    var self = this;
    var obosvc = Service.lookup("TestOboService", "default");
    var svc = Service.lookup("CacheService", "default");

    this.bldgappid = "${PARAMS.ctcno}_bldgapp";
    this.ctcno = "${PARAMS.ctcno}";

      this.ctx = this;
      this.items = [];
      this.ctc;
      this.bldgapp;
      this.locations;
      this.trackingno;
      this.selectedItem;
      this.list = [];
      this.permits = [];
      //this.obolist;
      this.removeItem = function(){
        var idx;
        for (var i=0; i<self.items.length; i++) {
          var x = self.items[ i ];
          if (x.id == self.removeid) {
            idx = i;
            break;
          }
        }

        self.items.splice(idx, 1);


        //this.items.pop(this.selectedItem);

        svc.removeCache( {key: self.ctcno + "_permit_" + self.selectedItem.id} );
        svc.put({key: self.ctcno + "_permits", value: self.items});
      }

      this.onload = function() {
        self.ctc = svc.get( "${PARAMS.ctcno}" );
        self.locations = svc.get( "${PARAMS.ctcno}_location" );
        self.bldgapp = svc.get( "${PARAMS.ctcno}_bldgapp" );
        self.trackingno = svc.get( "${PARAMS.ctcno}_trackingno" );
        var val = svc.get( "${PARAMS.ctcno}_permits" );
        if (val != null) {
          self.items = val;
        }
        window.console.log( self.items );

        self.permits = obosvc.getPermits({appid: self.bldgappid});

        self.list = [];
        var list = obosvc.getSections();
        for (var i=0; i<list.length; i++) {
          var x = list[i];
          if (x!=null) {
            self.list.push({id: x.objid.toLowerCase(), title: x.title, name: x.objid.toLowerCase()});
          }
        }
        //window.console.log( self.trackingno );


      //window.console.log( self.ctc)
      //window.console.log( self.locations)
      //window.console.log( self.bldgapp)

      }

      this.indexOf = function(jsondata, key) { 
        var fval = jsondata[key]; 
        for (var i=0; i<self.items.length; i++) {
          var item = self.items[i]; 
          if (fval == item[key]) return i;
        }
        return -1;
      }

      this.getPermits = function() {
        var p = {};
        for (var i=0; i<self.items.length; i++) {
          var x = self.items[i];
          p[x.name] = x.id;
        }
        return p;
      }

      this.addItem = function() {
        var handler = function() {

        }

        var params = {
          callbackHandler: handler,
          active: self.getActive()
        }
        return new PopupOpener ("requirements", params);
      }

      this.xadditem = function(){
        var handler = function(items){   
        //window.console.log( items );     
          for( var i=0; i<items.length; i++ ) { 
               if (self.indexOf(items[i], 'id') < 0 ) {
                  //window.console.log( items[i] )
                  var x = items[i];
                  var key = self.ctcno + "_permit_" + x.id;
                  var val = svc.get( key );
                  if (!val || val == null) {
                    svc.put({key: key, value: {}});
                  }
                self.items.push( items[i] );
               } 
          }

          svc.put({key: self.ctcno + "_permits", value: self.items});
        }
        var permit = self.getPermits();
        //window.console.log( permit );

        var params = {
          callbackHandler: handler,
          list: self.list,
          permit: permit
        }
        
        return new PopupOpener ("requirements", params);
      }

      this.hasItems = function(){
        return (this.items.length > 0);
      }
});
</script>
  <div id="content" style="margin-bottom: 450px;">
    <div class="container">
      <div class="primary">
          <div class="home">
            <h1>Application for New Building Permit</h1>
            <br>
            <div class="row">
                <div class="col-md-12">
                    <form method="POST" action="/partners/${PARAMS.name}/services/buildingpermit/buildingapplication/permitrequirements">
                        <div class="row">
                          <div class="col-md-12">

                            <div class="col-md-3">
                              <p class="font16">Tracking No. </p>
                              <p class="font16">Owner </p>
                              <p class="font16">Project Title </p>
                              <p class="font16">Scope of Work </p>
                              <p class="font16">Use or Character of Occupancy </p>
                              <p class="font16">Occupancy Classified </p>
                              <p class="font16">No. of Units </p>
                              <p class="font16">Total Floor Area (sqm) </p>
                               <p class="font16">Total Estimated Cost </p>
                               <p class="font16">Proposed Date of Const </p>
                               <p class="font16">Expected Comp. Date </p>
                            </div>
                            <div class="col-md-6">
                              <p class="font16" >: <label class="font16"  r:context="app" r:name="trackingno"></label></p>
                              <p class="font16" >: <label class="font16"  r:context="app" r:name="ctc.name"></label></p>
                              <p class="font16" >: <label class="font16"  r:context="app" r:name="bldgapp.entity.project"></label></p>
                              <p class="font16" >: <label class="font16"  r:context="app" r:name="bldgapp.entity.scopework"></label></p>
                              <p class="font16" >: <label class="font16"  r:context="app" r:name="bldgapp.entity.occupancy"></label></p>
                              <p class="font16" >: <label class="font16"  r:context="app" r:name="bldgapp.entity.classified"></label></p>
                              <p class="font16" >: <label class="font16"  r:context="app" r:name="bldgapp.entity.units"></label></p>
                              <p class="font16" >: <label class="font16"  r:context="app" r:name="bldgapp.entity.totalfloor"></label></p>
                              <p class="font16" >: <label class="font16"  r:context="app" r:name="bldgapp.entity.totalestimated"></label></p>
                              <p class="font16" >: <label class="font16"  r:context="app" r:name="bldgapp.application.proposedate"></label></p>
                              <p class="font16" >: <label class="font16"  r:context="app" r:name="bldgapp.application.expecteddate"></label></p>
                            </div>
  
                            
                          </div>
                    
                          <br>




                          <div class="col-md-12">


                              <table r:context="app" r:items="items" r:varName="x" width="100%" r:name="selectedItem" style="display:none" class="table">
                                <thead>
                                  <tr>
                                    <th scope="col">Permit Name</th>
                                    <th scope="col">Assign To</th>
                                    <th scope="col">Completed</th>
                                    <th scope="col"></th>
                                  </tr>
                                </thead>
                                  <tbody>
                                    <tr>
                                      <td>
                                        <a href="/partners/${PARAMS.name}/services/buildingpermit/buildingapplication/permits/permit-info?ctcno=${PARAMS.ctcno}&code=#{x.id}"> #{x.title}</a>

                                      </td>
                                      <td></td>
                                      <td><input type="checkbox"></td>
                                      <td><a r:context="app" r:name="removeItem" r:param_removeid="#{x.id}">remove</a></td>
                                    </tr>
                                    
                                  </tbody>
                                </table>
                          
                          
                          </div>
                        </div>
                       
                  
                          <div class="row" style="margin-top: 4%;">
                            <div class="col-md-2" >
                              <input r:context="app" r:name="additem" class="thumbnail btn btn-primary" type="submit" value="Add Permits">
                            </div>
                            <div class="col-md-2">
                              <form method="POST" action="">
                                  <div r:context="app" r:visibleWhen="#{ctx.hasItems()==true}" style="display:none">
                                    <input class="thumbnail btn btn-primary" type="button" value="Submit for Processing">
                                  </div>
                              </form>
                            </div>
                          </div>
                    </form>
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>

