
<%if( PARAMS.error !=null) { %>
<pre>Error ${PARAMS.error?.message}</pre>
<% } %>
<script>
\$register(  {id:"requirements", context: "requirements", 
  page: "/partners/${PARAMS.name}/services/buildingpermit/buildingapplication/permitrequirements", title:"Select Permits to Apply" }   )

  var controller = new function() {
    var self = this;
    var oboSvc = Service.lookup("TestOboService", "default");

    this.data;
    this.scope;
    this.removeid;
    this.file;

    this.onload = function() {
      self.data = oboSvc.getApplication({controlno: "${PARAMS.controlno}"});
      
      if (self.data) {
        self.scope = self.data.scope.join(",");
      }
      let selector = '#UploadFile';
      selector = '.file-upload';
      FilipizenUtil.fileUploadChangeEventListener(selector, function() {
        console.log('my change function');
        let id = \$(this).attr('id');
        if (id) {
          \$('#' + id + '-filename').val(this.value.substring(12));
        }
        //document.getElementById('FileName').value = this.value.substring(12);
        FilipizenUtil.uploadFile(this);
        console.log(FilipizenUtil.getFiles());
      });
      /*
      \$("#UploadFile").change(function() {
        document.getElementById('FileName').value = this.value.substring(12);
        FilipizenUtil.uploadFile(this);

      });
      */
      console.log(FilipizenUtil.getFiles());
      
      self.buildSubappContent();
    }

    this.buildValues = function( list ) {
      var values = {};

      if (list) {
        for (var i=0; i<list.length; i++) {
          var x = list[i];
          if (x) {
            var val = "unchecked";
            var ii = FilipizenUtil.findItem( self.data.subapplications, {sectionid: x.objid}, "sectionid");
            if (ii) {
              val = "checked";
            }
            values[x.objid] = val;
          }
        }
      }

      return values;
    }

    this.addItem = function() {
      var handler = function( items ) {
        var params = {
          appid: self.data.objid,
          list: self.buildPermitsToSave(items)
        }

        self.data.subapplications = oboSvc.saveSubapplications( params );
        self.buildSubappContent();
      }
      var list = oboSvc.getSections();

      var params = {
        callbackHandler: handler,
        list: list,
        values: self.buildValues( list )
      }
      return new PopupOpener ("requirements", params);
    }

    this.removeItem = function() {
      if (!self.removeid) return;
      oboSvc.removeSubapplication({objid: self.removeid});
      self.data.subapplications = oboSvc.getSubapplications({appid: self.data.objid});
        self.buildSubappContent();
    }

    this.buildPermitsToSave = function( src ) {
      var list = [];
      if (src) {
        for (var i=0; i<src.length; i++) {
          var x = src[i];
          var sectionid = x.objid;
          var item = FilipizenUtil.findItem( self.data.subapplications, {sectionid: sectionid}, "sectionid");
          if (!item) {
            item = {
              objid: oboSvc.generateId("SUBAPP"),
              appid: self.data.objid,
              sectionid: sectionid.toUpperCase()
            }
          }
          if (x.allowadd == true) item.allowadd = true;
          if (x.allowremove == true) item.allowremove = true;
          list.push( item );
        }
      }
      return list;
    }

    this.buildSubappContent = function() {
      var html = "<table class='table permitsTable' style='width:100%;'>";
      html += "<thead>";
      html += "<th scope='col'>Permit Name</th>";
      html += "<th scope='col' class='text-center'>Design Professional</th>";
      html += "<th scope='col' class='text-center'>Supervisor</th>";
      html += "<th scope='col' class='text-center'>Completed</th>";
      html += "<th scope='col' class='text-center'>Remove</th>";
      html += "</thead>";

      var list = self.data.subapplications;
      if (list) {
        var path = "/partners/${PARAMS.name}/services/buildingpermit/buildingapplication/permits/permit-info";
        html += "<tbody>";
        for (var i=0; i<list.length; i++) {
          var x = list[i];
          html += "<tr>";
          html += "<td><a href='" + path + "?subappid=" + x.objid + "&code=" + x.sectionid.toLowerCase() + "'>" + x.section.title + "</a></td>";
          html += "<td class='text-center'>";
          if (x.designprofessional.name != null) {
            html += x.designprofessional.name;
          }
          html += "</td>"
          html += "<td class='text-center'>";
          if (x.supervisor.name != null) {
            html += x.supervisor.name;
          }
          html += "</td>"
          /*
          html += "<td><input type='checkbox' id='" + x.objid + "' class='cb' r:context='app' r:mode='set' r:name='completed' r:checkedValue='" + x.objid + "'></td>";
          */
          html += "<td class='text-center'></td>";
          html += "<td class='text-center'><a id='" + x.objid + "-remove-button'";
          if (x.completed == 1) {
            html += " class='hide'";
          }
          html += " r:context='app' r:name='removeItem' r:param_removeid='" + x.objid + "'><i class='fa fa-trash'></i></a></td>";
          html += "</tr>";
        }
        html += "</tbody>";
      }
      html += "</table>";

      var elem = \$("#app-content");
      if (elem != null) {
        elem.html( html );
      }

      /*
      \$(".cb").change(function() {
        var id = \$(this).attr("id");
        if (id != null) {
          var rb = \$("#" + id + "-remove-button");
          if (\$(this).is(":checked")) {
            oboSvc.changeToCompleted( {objid: id, appid: self.bldgappid} );
            if (rb != null) rb.addClass("hide");
          } else {
            oboSvc.changeToNotCompleted( {objid: id, appid: self.bldgappid} );
            if (rb != null) rb.removeClass("hide");
          }
        }
      });
      */
    }

    this.getFile = function() {
      return FilipizenUtil.getFile();
    }

    this.displayPreview = function ( e ) {
        console.log(e.target.result);
        \$('.img-preview').attr('src', e.target.result);
      }

      this.saveToDb = function ( e ) {
        console.log(e);
        let blob = e.target.result;
        //console.log(blob);
      }

      this.asText = function( e ){
        console.log( e );
      }

      this.binaryString = function( e ){
        console.log( e );
      }

      this.readURL = function( input ) {
        if (input && input.files) {

          console.log(input.files);
          self.file = input.files[0];
          //var reader1 = new FileReader();
          //var reader2 = new FileReader();
          //var reader3 = new FileReader();
          //var reader4 = new FileReader();
          /*
          reader.onload = function(e) {
              console.log(e);
              //\$('.img-preview').attr('src', e.target.result);
          };
          */
          //reader.readAsDataURL(input.files[0]);

          //reader1.onload = self.displayPreview;
          //reader1.readAsDataURL(input.files[0]);

          //reader2.onload = self.saveToDb;
          //reader2.readAsArrayBuffer(input.files[0]);
          /*
          let f = input.files[0];

          let url = window.URL.createObjectURL(f);
          this.href = url;
          this.target = '_blank';

          //this.download = data.name;
          this.download = f.name;
          */
          /*
          reader3.onload = self.asText;
          reader3.readAsText(input.files[0]);

          reader4.onload = self.binaryString;
          reader4.readAsBinaryString(input.files[0]);
          */

        }
      }
  }



  \$put( "app", controller );

  \$(document).ready(function() {
    \$("#download").click(function() {
      //let url = window.URL.createObjectURL(data);
      let file = controller.getFile();
      let url = window.URL.createObjectURL(file);
      this.href = url;
      this.target = '_blank';

      this.download = file.name;
    
    })
  });

</script>


<div id="content" style="margin-bottom: 450px;">
  <div class="container">
    <div class="primary">
        <div class="home">
          <h1>Building Permit Application</h1>
          <br>
          <div class="row">
              <div class="col-md-12">
                      <div class="row">
                        <div class="col-md-12">
                          <div class="row">
                            <div class="col-md-6">
                              <dl class="dl-horizontal">
                                <dt>Application Type :</dt>
                                <dd><label r:context="app" r:name="data.apptype"></label></dd>
                                <dt>Tracking No. :</dt>
                                <dd><label r:context="app" r:name="data.controlno"></label></dd>
                                <dt>Owner :</dt>
                                <dd><label r:context="app" r:name="data.owner.name"></label></dd>
                                <dt>Scope of Work  :</dt>
                                <dd><label r:context="app" r:name="scope"></label></dd>
                                <dt>Occupancy Classification</dt>
                                <dd><label r:context="app" r:name="data.classification.title" ></label></dd>
                                <dt>Character of Occupancy</dt>
                                <dd><label r:context="app" r:name="data.occupancyuse.description"></label></dd>
                              </dl>
                            </div>      
                            <div class="col-md-6">
                              <dl class="dl-horizontal">
                                <dt>No. of Units :</dt>
                                <dd><label r:context="app" r:name="data.units"></label></dd>
                                <dt>Total Floor Area (sqm) :</dt>
                                <dd><label r:context="app" r:name="data.floorarea"></label></dd>
                                <dt>Total Estimated Cost</dt>
                                <dd><label r:context="app" r:name="data.estimatedcost"></label></dd>
                                <dt>Proposed Date of Const</dt>
                                <dd><label r:context="app" r:name="data.dtproposedconstruction"></label></dd>
                                <dt><b>Expected Comp. Date</dt>
                                <dd><label r:context="app" r:name="data.dtexpectedcompletion"></label></dd>
                              </dl>
                              <div id="ctcexpired"  class="hide expiredMsg">
                                <p><i>Your CTC is expired. </i><a href="/partners/${PARAMS.name}/services/e-cedula/ctcform?ctcno=${PARAMS.ctcno}" class="active-link">Renew CTC No.</a></p>
                              </div>
                            </div>
                          </div> 
                        </div> 
                      </div>
                      @box2(title:'Supervisor', context: 'app', name: "data.supervisor", editfunc: 'editProfessional')
                      <br>
                      <br>
                    <div class="row">
                      <div class="col-md-12">
                        <div class="tabbable tabbable-custom tabbable-full-width">
                          <ul class="nav nav-tabs">
                            <li class="active"><a href="#tab_overview" data-toggle="tab">Permit(s)</a></li>
                            <li><a href="#tab_edit_account" data-toggle="tab">Requirements</a></li>
                          </ul>

                          <div class="tab-content row">
                            <div class="tab-pane active" id="tab_overview">
                              <br>
                             <form method="POST" action="/partners/${PARAMS.name}/services/buildingpermit/buildingapplication/permitrequirements">
                             <div class="col col-md-12">
                                <div class="panel panel-default panel-table">
                                  <div class="panel-heading">
                                    <div class="row">
                                      <div class="col col-md-2">
                                        <button r:context="app" r:name="addItem" class="btn btn-primary" type="submit" ><i class="fa fa-plus"></i> Add Permit(s)</button>
                                      </div>
                                    </div>
                                  </div>
                                  <div class="panel-body">
                                    <div id="app-content"></div>                          
                                  </div>
                                </div>
                              </div>
                              </form>
                            </div>
                            <div class="tab-pane" id="tab_edit_account">
                              <div class="col col-md-12">
                                  <div class="panel panel-default panel-table">
                                      <div class="panel-body">
                                        <!--
                                        <div class="main-img-preview">
                                          <img class="thumbnail img-preview" src="" title="Preview">
                                        </div>
                                      -->
                                        <div class="form-group row">
                                          <div class="col-md-4">
                                            <label class="font16"><b>Document 1 </b></label>
                                          </div>
                                          <div class="col-md-2">
                                            <div class="fileUpload btn btn-primary">
                                              <span><i class="fa fa-paperclip"></i> Attch File</span> 
                                              <input id="uf1" type="file" class="file-upload">
                                            </div>
                                          </div>
                                          <div class="col-md-6">
                                            <input id="uf1-filename" class="fileName" disabled="disabled">
                                          </div>
                                        </div> 
                                        <div class="form-group row">
                                            <div class="col-md-4">
                                              <label class="font16"><b>Document 2 </b></label>
                                            </div>
                                            <div class="col-md-2">
                                              <div class="fileUpload btn btn-primary">
                                                <span><i class="fa fa-paperclip"></i> Attch File</span> 
                                                <input id="uf2" type="file" class="file-upload">
                                              </div>
                                            </div>
                                            <div class="col-md-6">
                                              <input id="uf2-filename" class="fileName" disabled="disabled">
                                            </div>
                                        </div> 
                                        <div class="form-group row">
                                            <div class="col-md-4">
                                              <label class="font16"><b>Document 3 </b></label>
                                            </div>
                                            <div class="col-md-2">
                                              <div class="fileUpload btn btn-primary">
                                                <span><i class="fa fa-paperclip"></i> Attch File</span> 
                                                <input id="uf3" type="file" class="file-upload">
                                              </div>
                                            </div>
                                            <div class="col-md-6">
                                              <input id="uf3-filename" class="fileName" disabled="disabled">
                                            </div>
                                        </div>                     
                                    </div>
                                </div>
                              </div>
                            </div>
                          </div> 
                        </div>
                      </div>
                    </div> 
                </div>
              </div>
          </div>
      </div>
    </div>
  </div>


 







<script type="text/javascript">
 /* 
var data =  { hi: "hello, world"}

document.getElementById('download').onclick = function(event){

    var json = JSON.stringify(data),
    blob = new Blob([json], {type: "octet/stream"}),
    url = window.URL.createObjectURL(blob);
  
    this.href = url;
    this.target = '_blank';
    
    // target filename
    this.download = 'foobar.text';
  */

  /*
  var data = new File(['foo','bar'], 'foobar.txt');

  document.getElementById('download').onclick = function(e){
    url = window.URL.createObjectURL(data);

    this.href = url;
    this.target = '_blank';

    this.download = data.name;
  
  }
  */



</script>


<!--
<script type="text/javascript">
\$(document).ready(function() {
    //var fileupload = document.getElementById('UploadFile');
    var fileupload = \$("#UploadFile");
    if (fileupload) {
      fileupload.change(function() {
        document.getElementById('FileName').value = this.value.substring(12);
        readURL(this);
      });
    }
    /*
    brand.className = 'attachment_upload';
    brand.onchange = function() {
        document.getElementById('FileName').value = this.value.substring(12);
    };
    */

    /*
    // Source: http://stackoverflow.com/a/4459419/6396981
    function readURL(input) {
      console.log(input.files[0]);
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            
            reader.onload = function(e) {
                \$('.img-preview').attr('src', e.target.result);
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    \$("#UploadFile").change(function() {
        readURL(this);
    });
*/
});

function readURL( input ) {
  console.log(input.files);
  if (input.files) {
    //var reader1 = new FileReader();
    var reader2 = new FileReader();
    /*
    reader.onload = function(e) {
        console.log(e);
        //\$('.img-preview').attr('src', e.target.result);
    };
    */
    //reader.readAsDataURL(input.files[0]);

    //reader1.onload = displayPreview;
    //reader1.readAsDataURL(input.files[0]);

    reader2.onload = saveToDb;
    reader2.readAsArrayBuffer(input.files[0]);
  }
}

function displayPreview( e ) {
  console.log(e.target.result);
  \$('.img-preview').attr('src', e.target.result);
}

function saveToDb( e ) {
  //console.log('save to db');
  let blob = e.target.result;
  //console.log(blob);
}
</script>
-->
