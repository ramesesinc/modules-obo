import com.rameses.annotations.*; 

class OboOnlinePaymentInterceptor {

	@Service("NumberService")
	def numSvc;

	@After(pattern="EPaymentService.getBilling", eval="#{args[0].txntype=='obo'}")
	public void fetchBilling( def evt ) { 
		
	}

	@Before(pattern="EPaymentService.createPaymentOrder", eval="#{args[0].txntype=='obo'}")
	public void createPaymentOrder( def evt ) { 
		def o = evt.args[0];
		o.appno = o.refno;
		def z = generateBilling(o);

		def m = [:];
		m.payer = z.app.business.owner;
		m.paidby = z.app.tradename;
		m.paidbyaddress = z.app.businessaddress;
		m.particulars = 'Business Permit';
		m.refid = z.app.objid;
		m.refno = o.appno;
		m.info = z.payment;
		m.amount = z.amount;
		m.txntype = 'bpls';
		m.txntypename = 'Business Permit';
		m.expirydate = z.expirydate;

		//retrieve the contactinfo
		def contact = [:];
		def c = appEm.find( [objid: z.app.objid ] ).select("business.*").first();
		def biz  = c.business;
		m.mobileno = (biz.mobileno) ? biz.mobileno : biz.owner.mobileno;
		m.email = (biz.email) ? biz.email : biz.owner.email;
		m.phoneno = (biz.phoneno) ? biz.phoneno : biz.owner.phoneno;
		o.info = m;
	}

	@After(pattern="EORService.post", eval="#{args[0].txntype=='obo'}")
	public void afterPostPayment( def evt ) { 
		def o = evt.args[0]; 
		def res = evt.result; 
		o.reftype = 'eor';
		o.receiptno = res.receiptno; 
		o.receiptdate = res.receiptdate;
		postPaymentSvc.postPayment( o ); 
	} 
}
