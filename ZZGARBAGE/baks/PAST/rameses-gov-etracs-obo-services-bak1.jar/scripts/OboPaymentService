import com.rameses.annotations.*; 

class OboPaymentService {

	@Service("WorkflowTaskService")
	def wfSvc;

	@DataContext(dynamic=true)
	def dynaDb;

	@ProxyMethod
	public void postPayment( po ) { 
		def rct = po.receipt;
		def appid = po.refid;

		//create the payment
		def receipt = [:];
		receipt.appid = appid;
		receipt.refid = rct.objid;
		receipt.refno = rct.receiptno;
		receipt.reftype = rct.type;
		receipt.refdate = rct.receiptdate;
		receipt.amount = rct.amount;
		receipt.voided = 0;

		def txntype = po.txntype.toString(); 
		def pmtEm = dynaDb.lookup( txntype +'_payment' ); 
		pmtEm.create( receipt );

		//post to the ledger
		def vwAppEm = dynaDb.lookup( 'vw_'+ txntype ); 
		def app = vwAppEm.find([ objid: appid ]).first(); 

		def appFeeEm = dynaDb.lookup( txntype +'_fee' );  
		appFeeEm.find([ appid: app.objid ]).update([ amtpaid: "{amount}" ]); 

		//fire the workflow for release.
		def m = [:];
		m.processname = txntype;
		m.action = "post-payment";
		m.taskid = app.taskid;
		m.refid = app.objid;
		wfSvc.signal( m ); 
	} 
} 
